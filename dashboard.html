<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Student Dashboard ‚Äì MKPS</title>
  <meta name="theme-color" content="#ffffff"/>
  <link rel="manifest" href="manifest.json"/>
  <style>
    :root{
      --primary:#0a558c;--primary-light:#0f73bf;
      --bg:#ffffff;--text:#111;--card:#f7f9fc;--border:#e1e5eb;
      --success:#2e7d32;--error:#d93025;--radius:12px;--shadow:0 4px 12px rgba(0,0,0,.08);
      font-size:16px;
    }
    [data-theme="dark"]{
      --bg:#121212;--text:#eee;--card:#1e1e1e;--border:#333;--shadow:0 4px 12px rgba(0,0,0,.4);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',system-ui,Arial}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;min-height:100vh}
    header{position:sticky;top:0;z-index:30;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    header img{height:34px;border-radius:50%}
    header h1{font-size:1.1rem;font-weight:600;margin-left:.5rem}
    .top-actions{display:flex;gap:.5rem;align-items:center}
    .top-actions button{background:none;border:none;color:#fff;font-size:1.4rem;cursor:pointer}
    main{flex:1;display:flex;flex-direction:column}
    .page{flex:1;padding:1rem;display:none;animation:fadeIn .3s}
    .page.active{display:block}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:1rem;box-shadow:var(--shadow)}
    .card h3{margin-bottom:.5rem;font-size:1.05rem}
    .chip{display:inline-block;background:var(--primary);color:#fff;font-size:.75rem;padding:.25rem .6rem;border-radius:20px;margin-right:.3rem;margin-bottom:.3rem}
    .badge{position:absolute;top:-6px;right:-6px;background:var(--error);color:#fff;border-radius:50%;font-size:.7rem;width:18px;height:18px;display:grid;place-items:center}
    .tab-bar{position:sticky;bottom:0;background:var(--bg);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:.35rem 0}
    .tab-bar button{background:none;border:none;font-size:.7rem;color:var(--text);display:flex;flex-direction:column;align-items:center;cursor:pointer}
    .tab-bar button.active{color:var(--primary)}
    .tab-bar button span{font-size:1.4rem}
    #toast{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:#323232;color:#fff;padding:.7rem 1rem;border-radius:6px;font-size:.9rem;z-index:100;opacity:0;transition:opacity .3s}
    #toast.show{opacity:1}
    .hidden{display:none}
    .list-item{display:flex;justify-content:space-between;align-items:center;padding:.6rem 0;border-bottom:1px solid var(--border)}
    .list-item:last-child{border:none}
    .list-item .title{font-weight:600}
    .list-item .subtitle{font-size:.8rem;opacity:.8}
    .expandable{cursor:pointer}
    .expandable-content{display:none;padding:.4rem 0;font-size:.9rem;color:var(--text)}
    .expandable.open .expandable-content{display:block}
    .btn-small{background:var(--primary);color:#fff;border:none;border-radius:4px;padding:.4rem .7rem;font-size:.8rem;cursor:pointer}
    .btn-small.danger{background:var(--error)}
    .floating-btn{position:fixed;bottom:70px;right:15px;background:var(--primary);color:#fff;border:none;border-radius:50%;width:56px;height:56px;font-size:1.8rem;box-shadow:var(--shadow);cursor:pointer}
    input,textarea,select{width:100%;padding:.5rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text)}
    textarea{resize:vertical;min-height:80px}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:200}
    .modal.active{display:flex}
    .modal-content{background:var(--card);border-radius:var(--radius);padding:1rem;max-width:90%;width:400px;max-height:85vh;overflow-y:auto}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
    .modal header button{background:none;border:none;font-size:1.3rem;color:var(--text);cursor:pointer}
    @media(max-width:600px){.card{margin:.5rem}}
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center">
    <img src="https://i.postimg.cc/ryGx49TB/erasebg-transformed.png" alt="Logo"/>
    <h1>MKPS Student</h1>
  </div>
  <div class="top-actions">
    <button id="themeToggle" aria-label="Toggle theme">üåô</button>
    <button id="bellBtn" aria-label="Notifications">üîî</button>
    <button id="threeDotBtn" aria-label="More">‚ãÆ</button>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="homePage" class="page active">
    <div class="card">
      <h3 data-lang-key="welcome">Welcome</h3>
      <p><span id="stuName"></span> ‚Ä¢ <span id="stuClass"></span></p>
    </div>

    <div class="card">
      <h3>Timetable</h3>
      <div id="timetableToday"></div>
    </div>

    <div class="card">
      <h3>Homework</h3>
      <div id="hwToday"></div>
    </div>

    <div class="card">
      <h3>Attendance</h3>
      <p id="attendanceSummary">Loading‚Ä¶</p>
    </div>

    <div class="card">
      <h3>Latest Result</h3>
      <p id="latestResult">Loading‚Ä¶</p>
    </div>
  </section>

  <!-- HOMEWORK -->
  <section id="hwPage" class="page">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Homework</h2>
      <select id="hwFilter">
        <option value="all">All</option>
        <option value="pending">Pending</option>
        <option value="submitted">Submitted</option>
      </select>
    </div>
    <div id="hwList"></div>
  </section>

  <!-- TIMETABLE -->
  <section id="timePage" class="page">
    <h2>Timetable</h2>
    <div id="timetableFull"></div>
  </section>

  <!-- NOTES -->
  <section id="notesPage" class="page">
    <h2>Notes</h2>
    <div id="notesList"></div>
  </section>

  <!-- MESSAGES -->
  <section id="msgPage" class="page">
    <h2>Messages</h2>
    <div id="msgList"></div>
    <div style="margin-top:1rem">
      <textarea id="msgInput" placeholder="Type message‚Ä¶"></textarea>
      <button class="btn-small" onclick="sendMessage()">Send</button>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="profilePage" class="page">
    <h2>Profile</h2>
    <div class="card">
      <label>Name</label>
      <input id="profileName" type="text"/>
      <label>Parent Name</label>
      <input id="profileParent" type="text"/>
      <label>Class</label>
      <select id="profileClass">
        <option>Nursery</option><option>1</option><option>2</option><option>3</option><option>4</option>
        <option>5</option><option>6</option><option>7</option><option>8</option>
      </select>
      <label>Email</label>
      <input id="profileEmail" type="email" readonly/>
      <button class="btn-small" onclick="saveProfile()">Save</button>
    </div>
  </section>
</main>

<!-- Bottom Nav -->
<nav class="tab-bar">
  <button class="tab-btn active" data-page="homePage"><span>üè†</span><small>Home</small></button>
  <button class="tab-btn" data-page="hwPage"><span>üìö</span><small>HW</small></button>
  <button class="tab-btn" data-page="timePage"><span>üïí</span><small>Time</small></button>
  <button class="tab-btn" data-page="notesPage"><span>üìù</span><small>Notes</small></button>
  <button class="tab-btn" data-page="msgPage"><span>üí¨</span><small>Msgs</small></button>
</nav>

<!-- Modals -->
<div class="modal" id="uploadModal">
  <div class="modal-content">
    <header>
      <h3>Upload HW</h3>
      <button onclick="closeModal('uploadModal')">‚úñ</button>
    </header>
    <form id="uploadForm">
      <label>Title</label>
      <input id="uploadTitle" required/>
      <label>Description</label>
      <textarea id="uploadDesc"></textarea>
      <label>Attachment (img/pdf)</label>
      <input type="file" id="uploadFile" accept="image/*,application/pdf"/>
      <button class="btn-small" type="submit">Upload</button>
    </form>
  </div>
</div>

<div id="toast"></div>

<script>
  /* ====== Utilities ====== */
  const StorageUtil = {
    prefix:'mkps_',
    get(k){return JSON.parse(localStorage.getItem(this.prefix+k)||'null')},
    set(k,v){localStorage.setItem(this.prefix+k,JSON.stringify(v))},
    remove(k){localStorage.removeItem(this.prefix+k)}
  };
  const i18n = {
    dict:{
      en:{welcome:'Welcome'},hi:{welcome:'‡§∏‡•ç‡§µ‡§æ‡§ó‡§§'}
    },
    lang:'en',
    t(k){return this.dict[this.lang]?.[k]||k},
    setLang(l){this.lang=l;StorageUtil.set('lang',l);}
  };
  i18n.setLang(StorageUtil.get('lang')||'en');
  const toast = (msg)=>{
    const el=document.getElementById('toast');
    el.textContent=msg;el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'),3000);
  };
  const applyTheme=()=>{
    const t=StorageUtil.get('theme')||(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
    document.documentElement.setAttribute('data-theme',t);
    document.getElementById('themeToggle').textContent=t==='dark'?'‚òÄÔ∏è':'üåô';
  };
  applyTheme();
  document.getElementById('themeToggle').onclick=()=>{
    const newTheme=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
    StorageUtil.set('theme',newTheme);applyTheme();
  };

  /* ====== Navigation ====== */
  const pages=document.querySelectorAll('.page');
  const tabBtns=document.querySelectorAll('.tab-btn');
  const showPage=id=>{
    pages.forEach(p=>p.classList.remove('active'));
    tabBtns.forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelector(`[data-page="${id}"]`).classList.add('active');
  };
  tabBtns.forEach(btn=>btn.onclick=()=>showPage(btn.dataset.page));

  /* ====== Current User ====== */
  const user=StorageUtil.get('currentUser');
  if(!user || user.role!=='student'){location.href='index.html';}
  document.getElementById('stuName').textContent=user.name;
  document.getElementById('stuClass').textContent=user.cls;

  /* ====== Data Helpers ====== */
  const getData=(key,def=[])=>StorageUtil.get(key)||def;
  const saveData=(key,val)=>StorageUtil.set(key,val);

  /* ====== Timetable ====== */
  const renderTimetableToday=()=>{
    const tt=getData('timetable')[user.cls]||[];
    const today=new Date().toLocaleString('en-us',{weekday:'long'});
    const day=tt.find(d=>d.day===today);
    const container=document.getElementById('timetableToday');
    if(!day){container.innerHTML='No classes today';return;}
    container.innerHTML=day.periods.map(p=>`<div class="chip">${p.subject} ${p.time}</div>`).join('');
  };
  const renderTimetableFull=()=>{
    const tt=getData('timetable')[user.cls]||[];
    const container=document.getElementById('timetableFull');
    container.innerHTML=tt.map(d=>`<div class="card"><b>${d.day}</b>${d.periods.map(p=>`<div class="list-item"><span>${p.subject}</span><span>${p.time}</span></div>`).join('')}</div>`).join('');
  };

  /* ====== Homework ====== */
  const renderHW=()=>{
    const hwList=getData('homework').filter(h=>h.cls===user.cls);
    const filter=document.getElementById('hwFilter').value;
    let list=hwList;
    if(filter==='pending')list=hwList.filter(h=>!h.submitted);
    if(filter==='submitted')list=hwList.filter(h=>h.submitted);
    const container=document.getElementById('hwList');
    container.innerHTML=list.map(h=>`
      <div class="card expandable ${h.submitted?'submitted':''}" data-id="${h.id}">
        <div class="expandable-header">
          <div class="title">${h.title}</div>
          <div class="subtitle">${h.dueDate}</div>
        </div>
        <div class="expandable-content">
          <p>${h.desc}</p>
          ${h.attachment?`<a href="${h.attachment}" target="_blank">üìé View Attachment</a>`:''}
          ${h.submitted?'<p style="color:var(--success)">‚úÖ Submitted</p>':`<button class="btn-small" onclick="markSubmitted('${h.id}')">Mark Submitted</button>`}
        </div>
      </div>
    `).join('');
    document.querySelectorAll('.expandable').forEach(el=>{
      el.querySelector('.expandable-header').onclick=()=>el.classList.toggle('open');
    });
  };
  document.getElementById('hwFilter').onchange=renderHW;

  const markSubmitted=id=>{
    const hw=getData('homework');
    const h=hw.find(x=>x.id===id);
    if(h){h.submitted=true;saveData('homework',hw);renderHW();toast('Marked submitted');}
  };

  /* ====== Notes ====== */
  const renderNotes=()=>{
    const notes=getData('notes').filter(n=>n.cls===user.cls);
    document.getElementById('notesList').innerHTML=notes.map(n=>`<div class="card"><b>${n.title}</b><p>${n.content}</p></div>`).join('');
  };

  /* ====== Messages ====== */
  const renderMessages=()=>{
    const msgs=getData('messages').filter(m=>m.to==='student'||m.from===user.name);
    const container=document.getElementById('msgList');
    container.innerHTML=msgs.map(m=>`<div class="card" style="margin-bottom:.5rem"><b>${m.from}</b><p>${m.text}</p><small>${new Date(m.time).toLocaleString()}</small></div>`).join('');
  };
  const sendMessage=()=>{
    const txt=document.getElementById('msgInput').value.trim();
    if(!txt)return;
    const msgs=getData('messages');
    msgs.push({from:user.name,to:'teacher',text:txt,time:Date.now()});
    saveData('messages',msgs);
    document.getElementById('msgInput').value='';
    renderMessages();
  };

  /* ====== Attendance & Results ====== */
  const renderSummary=()=>{
    const att=getData('attendance')[user.cls]?.[user.name]||{present:0,total:0};
    document.getElementById('attendanceSummary').textContent=`${att.present}/${att.total} days`;
    const res=getData('results')[user.cls]?.[user.name]||[];
    const latest=res[res.length-1];
    document.getElementById('latestResult').textContent=latest?`${latest.exam}: ${latest.marks}%`:'No results yet';
  };

  /* ====== Profile ====== */
  const loadProfile=()=>{
    document.getElementById('profileName').value=user.name;
    document.getElementById('profileParent').value=user.parentName;
    document.getElementById('profileClass').value=user.cls;
    document.getElementById('profileEmail').value=user.email||'';
  };
  const saveProfile=()=>{
    user.name=document.getElementById('profileName').value;
    user.parentName=document.getElementById('profileParent').value;
    user.cls=document.getElementById('profileClass').value;
    saveData('currentUser',user);
    toast('Saved');
  };

  /* ====== Upload HW Modal ====== */
  document.getElementById('uploadForm').onsubmit=e=>{
    e.preventDefault();
    const title=document.getElementById('uploadTitle').value;
    const desc=document.getElementById('uploadDesc').value;
    const file=document.getElementById('uploadFile').files[0];
    const hw=getData('homework');
    const id='hw_'+Date.now();
    let attachment='';
    if(file){
      const reader=new FileReader();
      reader.onload=()=>{
        attachment=reader.result;
        hw.unshift({id,cls:user.cls,title,desc,dueDate:new Date().toLocaleDateString(),submitted:false,attachment});
        saveData('homework',hw);
        renderHW();closeModal('uploadModal');
      };
      reader.readAsDataURL(file);
    }else{
      hw.unshift({id,cls:user.cls,title,desc,dueDate:new Date().toLocaleDateString(),submitted:false});
      saveData('homework',hw);
      renderHW();closeModal('uploadModal');
    }
  };
  const closeModal=id=>document.getElementById(id).classList.remove('active');
  document.querySelector('.floating-btn').onclick=()=>document.getElementById('uploadModal').classList.add('active');

  /* ====== Realtime sync ====== */
  window.addEventListener('storage',e=>{
    if(e.key.startsWith('mkps_')){
      renderTimetableToday();renderHW();renderNotes();renderMessages();
    }
  });

  /* ====== Initial renders ====== */
  renderTimetableToday();renderTimetableFull();renderHW();renderNotes();renderMessages();renderSummary();loadProfile();
</script>
</body>
</html>
