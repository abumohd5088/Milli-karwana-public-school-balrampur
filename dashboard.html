<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Äî Milli Karwaan Public School Balrampur</title>
  <meta name="description" content="Student dashboard for Milli Karwaan Public School Balrampur ‚Äî class-specific homework, AI study helper, notices, timetable, teachers, gallery and admin hooks." />
  <link rel="icon" href="https://i.postimg.cc/ryGx49TB/erasebg-transformed.png">
  <meta name="theme-color" content="#dc3545">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ============================
       MKPS Dashboard ‚Äî Internal CSS
       Mobile-first responsive, glassmorphism, animations, accessible
       ============================ */
    :root{
      --bg-1:#071422;
      --bg-2:#13293b;
      --card: rgba(255,255,255,0.04);
      --muted: #9fb0c6;
      --accent: #dc3545;
      --accent-2: #ff6f61;
      --glass-border: rgba(255,255,255,0.06);
      --radius: 14px;
      --shadow: 0 12px 40px rgba(2,6,23,0.6);
      --max: 1300px;
      --success: #28a745;
      --danger: #e55353;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    body{
      background: radial-gradient(1200px 600px at 10% 10%, rgba(255,110,110,0.04), transparent 8%),
                  radial-gradient(1000px 500px at 90% 90%, rgba(0,200,255,0.02), transparent 8%),
                  linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:#eaf2fb;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;flex-direction:column;align-items:center;
      min-height:100vh;
    }

    /* Container */
    .wrap{width:100%;max-width:var(--max);padding:16px;display:flex;flex-direction:column;gap:14px;}

    /* Header */
    header.appbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:12px;border-radius:12px;border:1px solid var(--glass-border);box-shadow:var(--shadow);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:64px;height:64px;border-radius:10px;object-fit:cover;box-shadow:0 8px 20px rgba(0,0,0,0.6)}
    .brand h1{font-size:1.05rem;margin:0}
    .brand p{margin:0;font-size:0.82rem;color:var(--muted)}
    .header-actions{display:flex;gap:8px;align-items:center}
    .callbtn{background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:8px 12px;border-radius:10px;color:#fff;text-decoration:none;font-weight:600}
    .icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:10px;color:#fff;cursor:pointer;display:flex;align-items:center;gap:8px}

    /* Layout: main + sidebar (mobile-first) */
    main{display:flex;flex-direction:column;gap:12px;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:980px){
      main{flex-direction:row}
      .grid{grid-template-columns: 1fr 360px}
    }

    /* Panels */
    .panel{
      background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--glass-border);
      box-shadow:0 6px 30px rgba(0,0,0,0.45);
    }
    h2,h3,h4{margin:0 0 8px 0}
    p.small{margin:0;color:var(--muted);font-size:0.92rem}

    /* Welcome area */
    .welcome{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .welcome-left{display:flex;gap:12px;align-items:center}
    .avatar{
      width:72px;height:72px;border-radius:12px;background:linear-gradient(90deg,#fff,rgba(255,255,255,0.06));display:flex;align-items:center;justify-content:center;color:#111;font-weight:700;
      font-size:1.1rem;box-shadow:0 8px 20px rgba(0,0,0,0.5)
    }
    .welcome-info{min-width:0}
    .welcome-info h3{font-size:1.06rem;margin-bottom:4px}
    .welcome-info p{margin:0;color:var(--muted);font-size:0.9rem}
    .welcome-actions{display:flex;gap:8px;align-items:center}

    /* Stats */
    .stats{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .stat{padding:10px 14px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));min-width:110px;text-align:center}
    .stat h4{margin:0}
    .stat p{margin:4px 0 0 0;color:var(--muted);font-size:0.85rem}

    /* Homework area */
    .hw-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .hw-controls input[type="search"], .hw-controls select{padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff;min-width:0;flex:1}
    .controls-right{display:flex;gap:8px}
    .btn{padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff}

    .hw-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px;margin-top:12px}
    @media(min-width:700px){ .hw-grid{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:1100px){ .hw-grid{grid-template-columns:repeat(3,1fr)} }

    .hw-card{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);transition:transform .12s ease,box-shadow .12s ease;}
    .hw-card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.6)}
    .hw-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .hw-sub{color:var(--muted);font-size:0.88rem}
    .hw-body{color:#e8f3ff;line-height:1.4}

    /* Teachers */
    .teachers{display:grid;grid-template-columns:repeat(1,1fr);gap:10px}
    @media(min-width:700px){ .teachers{grid-template-columns:repeat(2,1fr)} }
    .teacher{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)}
    .teacher img{width:64px;height:64px;border-radius:8px;object-fit:cover}

    /* Events & Notices */
    .event{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .notice{padding:10px;border-radius:10px;margin-bottom:8px}
    .notice.high{background:linear-gradient(90deg, rgba(255,80,80,0.06), rgba(255,80,80,0.02));border-left:4px solid rgba(255,80,80,0.7)}
    .notice.medium{background:linear-gradient(90deg, rgba(255,190,60,0.04), rgba(255,190,60,0.02));border-left:4px solid rgba(255,190,60,0.6)}
    .notice.low{background:linear-gradient(90deg, rgba(140,225,160,0.03), rgba(140,225,160,0.01));border-left:4px solid rgba(140,225,160,0.45)}

    /* Sidebar */
    aside.sidebar{display:flex;flex-direction:column;gap:12px}
    .side-panel{display:flex;flex-direction:column;gap:8px}
    .quick-search input{padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff}
    .counts{display:flex;gap:8px;flex-wrap:wrap}
    .count{flex:1;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));text-align:center}

    /* Gallery */
    .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .gallery img{width:100%;height:80px;object-fit:cover;border-radius:8px;cursor:pointer;transition:transform .15s}
    .gallery img:hover{transform:scale(1.03)}

    /* AI chatbox (floating) */
    .ai-fab{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:62px;height:62px;border-radius:999px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.3rem;cursor:pointer;box-shadow:0 18px 50px rgba(220,53,69,0.2);z-index:999}
    .ai-panel{position:fixed;right:18px;bottom:90px;width:360px;max-width:95%;border-radius:12px;background:var(--card);border:1px solid var(--glass-border);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden;z-index:999}
    .ai-panel .header{padding:10px;display:flex;align-items:center;justify-content:space-between;gap:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .ai-panel .messages{padding:10px;max-height:300px;overflow:auto}
    .ai-panel .input{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,0.02)}
    .ai-panel input{flex:1;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#fff}

    /* Footer */
    footer{margin-top:14px;padding:12px;text-align:center;color:var(--muted);font-size:0.92rem}

    /* Light mode adjustments (toggle) */
    body.light{color:#111;background:linear-gradient(180deg,#f5f8fb,#e9f1f7)}
    body.light .panel{background:#fff;color:#111;border:1px solid rgba(0,0,0,0.04)}
    body.light .brand p{color:#666}
    body.light .muted{color:#666}

    /* small helpers */
    .hidden{display:none}
    .muted{color:var(--muted)}
    a.link{color:var(--accent);text-decoration:none}

    /* Focus outlines for accessibility */
    :focus{outline:3px solid rgba(255,255,255,0.05);outline-offset:2px}
  </style>
</head>
<body>
  <div class="wrap" role="main" aria-label="MKPS Dashboard container">
    <!-- Header -->
    <header class="appbar panel" role="banner" aria-label="Header">
      <div class="brand" role="img" aria-label="Milli Karwaan Public School Logo and name">
        <img src="https://i.postimg.cc/ryGx49TB/erasebg-transformed.png" alt="MKPS logo">
        <div>
          <h1>Milli Karwaan Public School</h1>
          <p class="small">Boluha Police Chowki, Balrampur ¬∑ ‡§ú‡•ç‡§û‡§æ‡§®, ‡§Ö‡§®‡•Å‡§∂‡§æ‡§∏‡§® ‡§î‡§∞ ‡§∏‡§Æ‡§∞‡•ç‡§™‡§£ ‚Äî ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§ï‡•Ä ‡§∞‡§æ‡§π</p>
        </div>
      </div>

      <div class="header-actions" role="navigation" aria-label="Header actions">
        <div class="muted small">Email: <a class="link" href="mailto:madamsir066@gmail.com">madamsir066@gmail.com</a></div>
        <a class="callbtn" href="tel:9758919151">Call: 9758919151</a>
        <button id="exportDataBtn" class="icon-btn" title="Export data">Export</button>
        <button id="importDataBtn" class="icon-btn" title="Import data">Import</button>
        <button id="snapshotBtn" class="icon-btn" title="Download snapshot">Snapshot</button>
        <button id="themeToggle" class="icon-btn" title="Toggle theme">üåì</button>
        <button id="logoutBtn" class="icon-btn" title="Logout">Logout</button>
      </div>
    </header>

    <!-- Main -->
    <main>
      <div class="grid">
        <!-- LEFT: main content -->
        <section>
          <!-- Welcome Panel -->
          <div class="panel" id="welcomePanel" aria-live="polite">
            <div class="welcome">
              <div class="welcome-left">
                <div class="avatar" id="avatarPlaceholder" aria-hidden="true">MK</div>
                <div class="welcome-info">
                  <h3 id="studentNameTitle">Welcome, Student</h3>
                  <p id="studentMeta" class="small">Class ‚Äî Parent ‚Äî </p>
                  <div class="stats" id="miniStats">
                    <div class="stat"><h4 id="statHomework">‚Äî</h4><p>Homework</p></div>
                    <div class="stat"><h4 id="statTeachers">‚Äî</h4><p>Teachers</p></div>
                    <div class="stat"><h4 id="statEvents">‚Äî</h4><p>Events</p></div>
                    <div class="stat"><h4 id="statMessages">‚Äî</h4><p>Messages</p></div>
                  </div>
                </div>
              </div>
              <div class="welcome-actions" role="group" aria-label="Welcome actions">
                <button id="goHomework" class="btn btn-primary">View Homework</button>
                <button id="openAI" class="btn btn-ghost">Ask AI</button>
              </div>
            </div>
          </div>

          <!-- Homework Panel -->
          <div class="panel" id="homeworkPanel">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <h3>Homework</h3>
                <p class="small">Only homework for your selected class is shown by default.</p>
              </div>
              <div class="muted">Filter & Search</div>
            </div>

            <div class="hw-controls" style="margin-top:12px">
              <input id="hwSearch" type="search" placeholder="Search homework by keyword..." aria-label="Search homework">
              <select id="hwClassFilter" aria-label="Filter by class">
                <option value="">Show my class (default)</option>
                <!-- classes will be populated by JS -->
              </select>
              <div class="controls-right" style="margin-left:auto">
                <button id="refreshBtn" class="btn btn-ghost">Refresh</button>
                <button id="downloadHwBtn" class="btn btn-primary">Download Snapshot</button>
              </div>
            </div>

            <div id="hwGrid" class="hw-grid" aria-live="polite" style="margin-top:12px">
              <!-- Homework cards injected by JS -->
            </div>
          </div>

          <!-- Teachers & Events -->
          <div class="panel" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3>Teachers & Events</h3>
              <div class="muted">Contact teachers ¬∑ Upcoming events</div>
            </div>

            <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
              <div style="flex:1;min-width:260px">
                <h4>Teachers</h4>
                <div class="teachers" id="teachersList">
                  <!-- teacher cards -->
                </div>
              </div>

              <div style="width:320px;min-width:200px">
                <h4>Upcoming Events</h4>
                <div id="eventsList">
                  <!-- events -->
                </div>
              </div>
            </div>
          </div>

          <!-- Notices -->
          <div class="panel" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3>Notice Board</h3>
              <div class="muted">Important announcements</div>
            </div>
            <div id="noticesList" style="margin-top:12px">
              <!-- notices -->
            </div>
          </div>

          <!-- Timetable -->
          <div class="panel" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3>Timetable</h3>
              <div class="muted">Class schedule</div>
            </div>
            <div id="timetable" style="margin-top:10px">
              <!-- timetable injected -->
            </div>
          </div>

          <!-- Gallery -->
          <div class="panel" style="margin-top:12px">
            <h3>Gallery</h3>
            <p class="small">Click to enlarge photos.</p>
            <div class="gallery" id="galleryGrid" style="margin-top:10px"></div>
          </div>

          <!-- Achievements / Analytics -->
          <div class="panel" style="margin-top:12px">
            <h3>Achievements & Analytics</h3>
            <p class="small">Progress overview and recent highlights.</p>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
              <div style="flex:1;min-width:220px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)">
                <h4 id="achvCount">‚Äî</h4>
                <p class="small">Top Achievements</p>
              </div>
              <div style="flex:1;min-width:220px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)">
                <h4 id="attendancePercent">‚Äî</h4>
                <p class="small">Attendance</p>
              </div>
              <div style="flex:1;min-width:220px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)">
                <h4 id="avgScore">‚Äî</h4>
                <p class="small">Average Score</p>
              </div>
            </div>
          </div>

          <!-- FAQ & Resources -->
          <div class="panel" style="margin-top:12px">
            <h3>FAQ & Quick Resources</h3>
            <p class="small">Useful links and frequently asked questions.</p>
            <details style="margin-top:10px"><summary><strong>How to view homework?</strong></summary><p class="small">Use the search and class filter. Homework is saved in localStorage and updated by admin.</p></details>
            <details style="margin-top:6px"><summary><strong>How to contact a teacher?</strong></summary><p class="small">Click a teacher card and use the quick contact action (call/email).</p></details>
            <details style="margin-top:6px"><summary><strong>How to use AI helper?</strong></summary><p class="small">Click the floating AI button and type your homework question. AI answers are study-focused only.</p></details>
          </div>

          <!-- Placeholder for 50+ expandable items -->
          <div class="panel" style="margin-top:12px">
            <h3>More Modules (Expandable)</h3>
            <p class="small">These cards are placeholders for future modules: Exams, Results, Fees, Transport, Canteen, Library, Clubs, Alumni, Reports, Attendance Analysis etc.</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:10px">
              <!-- Create many placeholder cards to convey "unlimited features" feel -->
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Exams</div>
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Results</div>
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Fees</div>
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Transport</div>
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Canteen</div>
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Library</div>
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Clubs</div>
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Alumni</div>
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Reports</div>
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Downloads</div>
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Assignments</div>
              <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">Syllabus</div>
            </div>
          </div>
        </section>

        <!-- RIGHT: sidebar -->
        <aside class="sidebar">
          <div class="panel side-panel">
            <h4>Quick Search</h4>
            <div class="quick-search"><input id="quickSearch" placeholder="Search homework, teachers, notices"></div>
            <div style="margin-top:8px" class="counts">
              <div class="count"><h4 id="ccHw">0</h4><p class="small">Homework</p></div>
              <div class="count"><h4 id="ccTeachers">0</h4><p class="small">Teachers</p></div>
              <div class="count"><h4 id="ccEvents">0</h4><p class="small">Events</p></div>
            </div>
            <div style="margin-top:10px">
              <button id="viewMessagesBtn" class="btn btn-ghost" style="width:100%">View Saved Messages</button>
              <button id="contactBtn" class="btn btn-ghost" style="width:100%;margin-top:8px">Contact School</button>
            </div>
          </div>

          <div class="panel side-panel">
            <h4>Gallery Quick View</h4>
            <div id="miniGallery" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px"></div>
            <div style="margin-top:8px"><button id="openGalleryBtn" class="btn btn-primary" style="width:100%">Open Gallery</button></div>
          </div>

          <div class="panel side-panel">
            <h4>Timetable Quick</h4>
            <div id="ttMini" class="muted small" style="margin-top:6px"></div>
          </div>

          <div class="panel side-panel">
            <h4>Admin Quick</h4>
            <p class="small">Admin page is hidden. If you are admin, use the secret password to open admin panel (admin.html).</p>
            <button id="adminOpenBtn" class="btn btn-ghost" style="width:100%">Open Admin (Hidden)</button>
          </div>
        </aside>
      </div>
    </main>

    <footer role="contentinfo">¬© 2025 Milli Karwaan Public School, Balrampur. All Rights Reserved.</footer>
  </div>

  <!-- AI Floating FAB + Panel -->
  <div id="aiFab" class="ai-fab" aria-label="Open AI helper" title="Ask Study AI">ü§ñ</div>
  <div id="aiPanel" class="ai-panel hidden" role="dialog" aria-label="AI Study Helper">
    <div class="header">
      <div style="display:flex;gap:10px;align-items:center">
        <strong>Study AI</strong>
        <div class="muted small">Ask homework & study questions</div>
      </div>
      <div><button id="aiClose" class="icon-btn">‚úï</button></div>
    </div>
    <div id="aiMessages" class="messages" aria-live="polite" style="background:transparent"></div>
    <div class="input">
      <input id="aiInput" placeholder="Type your question about homework, math, science..." aria-label="AI question input">
      <button id="aiSend" class="btn btn-primary">Ask</button>
    </div>
  </div>

  <!-- Lightbox for gallery -->
  <div id="lightbox" class="hidden" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:9999">
    <div style="position:relative;max-width:95%;max-height:95%">
      <img id="lbImg" src="" alt="enlarged image" style="max-width:100%;max-height:100%;border-radius:10px">
      <button id="lbClose" class="icon-btn" style="position:absolute;top:-18px;right:-18px">‚úï</button>
    </div>
  </div>

  <!-- Hidden file input for import -->
  <input id="importFile" type="file" accept="application/json" class="hidden">

  <script>
    /**
     * Dashboard JS ‚Äî large, feature-rich client side functionality.
     * - Reads mkps_student from localStorage (set by index.html).
     * - Reads/Seeds mkps_homework, mkps_teachers, mkps_events, mkps_notices, mkps_timetable, mkps_gallery, mkps_messages.
     * - AI helper uses provided Google API keys (try sequentially).
     * - Exposes admin hooks for admin.html later.
     *
     * Inline comments explain key sections.
     */

    /* ---------------------------
       Helpers & Config
       --------------------------- */
    const AI_KEYS = [
      "AIzaSyCdzFBQ1KVgBfmmjSgHJJwcuLbqne9VjUs",
      "AIzaSyCqGS8gb5kh7Jr0pv8d84LxCLhgHU-O_VU"
    ];
    const GEN_API = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

    function uid(n=8){ return Math.random().toString(36).slice(2,2+n) }
    function now(){ return new Date().toISOString() }
    function safeParse(str, def=null){
      try{ return JSON.parse(str) } catch(e){ return def }
    }
    const storage = {
      get(k){ return safeParse(localStorage.getItem(k), null) },
      set(k,v){ localStorage.setItem(k, JSON.stringify(v)); localStorage.setItem('mkps_update', now()); },
      raw(k){ return localStorage.getItem(k) },
      remove(k){ localStorage.removeItem(k); localStorage.setItem('mkps_update', now()); }
    };

    /* ---------------------------
       Seed demo data if missing (only on first load)
       --------------------------- */
    function seedData(){
      if(!storage.get('mkps_homework')){
        const hw = {
          "1":[ { id:uid(), date:"2025-08-01", subject:"Mathematics", teacher:"Arif Khan", body:"Practice numbers 1‚Äì50 and draw 5 shapes." },
                { id:uid(), date:"2025-08-02", subject:"English", teacher:"Alka Sharma", body:"Learn A-F letters and practice writing." } ],
          "2":[ { id:uid(), date:"2025-08-01", subject:"Mathematics", teacher:"Arif Khan", body:"Tables of 2 and 3. Worksheet pages 3-4." } ],
          "3":[ { id:uid(), date:"2025-08-03", subject:"Science", teacher:"Shruti Verma", body:"Collect leaf samples from 3 plants." } ],
          "4":[ { id:uid(), date:"2025-08-04", subject:"English", teacher:"Prakash Singh", body:"Write a short paragraph on 'My School'." } ],
          "5":[ { id:uid(), date:"2025-08-04", subject:"Math", teacher:"Arif Khan", body:"Two-digit subtraction practice." } ],
          "6":[ { id:uid(), date:"2025-08-05", subject:"Computer", teacher:"Riya Thomas", body:"Intro to algorithms: write steps for a recipe." } ],
          "7":[ { id:uid(), date:"2025-08-06", subject:"Social Studies", teacher:"Neeraj Gupta", body:"Map exercise: mark rivers." } ],
          "8":[ { id:uid(), date:"2025-08-06", subject:"Science", teacher:"Shruti Verma", body:"Periodic table first 10 elements." } ]
        };
        storage.set('mkps_homework', hw);
      }
      if(!storage.get('mkps_teachers')){
        const t = [
          { id: uid(), name: "Arif Khan", subject: "Mathematics", phone: "", email: "", photo: "https://placehold.co/200x200?text=Arif" },
          { id: uid(), name: "Shruti Verma", subject: "Science", phone: "", email: "", photo: "https://placehold.co/200x200?text=Shruti" },
          { id: uid(), name: "Prakash Singh", subject: "English", phone: "", email: "", photo: "https://placehold.co/200x200?text=Prakash" },
          { id: uid(), name: "Riya Thomas", subject: "Computer Science", phone: "", email: "", photo: "https://placehold.co/200x200?text=Riya" },
          { id: uid(), name: "Neeraj Gupta", subject: "Social Studies", phone: "", email: "", photo: "https://placehold.co/200x200?text=Neeraj" },
          { id: uid(), name: "Alka Sharma", subject: "Hindi", phone: "", email: "", photo: "https://placehold.co/200x200?text=Alka" }
        ];
        storage.set('mkps_teachers', t);
      }
      if(!storage.get('mkps_events')){
        const ev = [
          { id:uid(), title:"Independence Day Program", date:"2025-08-15", time:"09:00", location:"School Ground", desc:"Flag hoisting and cultural program."},
          { id:uid(), title:"Annual Sports Meet", date:"2025-09-10", time:"07:30", location:"Sports Field", desc:"Athletics and group games."}
        ];
        storage.set('mkps_events', ev);
      }
      if(!storage.get('mkps_notices')){
        const ns = [
          { id:uid(), title:"COVID Guidelines", date:"2025-07-10", priority:"high", body:"Mask recommended for all visitors." },
          { id:uid(), title:"Library Timing", date:"2025-07-20", priority:"low", body:"Library open 8:00 AM - 2:00 PM." }
        ];
        storage.set('mkps_notices', ns);
      }
      if(!storage.get('mkps_timetable')){
        const tt = {
          "1":[["Math","English","EVS"],["Hindi","Art","Play"]],
          "2":[["Math","Science","English"],["Sports","Hindi","Math"]],
          "3":[["Math","Science","English"],["Computer","Hindi","Art"]],
          "4":[["Math","Science","English"],["Computer","Hindi","Art"]],
          "5":[["Math","Science","English"],["Computer","Hindi","Art"]],
          "6":[["Math","Science","English"],["Computer","Hindi","Social"]],
          "7":[["Math","Science","English"],["Computer","Hindi","Social"]],
          "8":[["Math","Science","English"],["Computer","Hindi","Social"]]
        };
        storage.set('mkps_timetable', tt);
      }
      if(!storage.get('mkps_gallery')){
        const gallery = [
          { id: uid(), src: "https://placehold.co/600x400?text=Campus+1", caption:"Campus view" },
          { id: uid(), src: "https://placehold.co/600x400?text=Assembly", caption:"Assembly" },
          { id: uid(), src: "https://placehold.co/600x400?text=Sports", caption:"Sports day" }
        ];
        storage.set('mkps_gallery', gallery);
      }
      if(!storage.get('mkps_messages')) storage.set('mkps_messages', []);
      if(!storage.get('mkps_meta')) storage.set('mkps_meta', { students:1245, teachers:6, notices:2, photos:3 });
    }

    // Run seed
    seedData();

    /* ---------------------------
       Read logged-in student
       --------------------------- */
    const student = storage.get('mkps_student');
    if(!student){
      // if no student, redirect to index (login)
      console.warn('No mkps_student found in localStorage. Redirecting to index.html');
      setTimeout(()=>{ location.href = 'index.html' }, 600);
    }

    /* ---------------------------
       DOM references
       --------------------------- */
    const studentNameTitle = document.getElementById('studentNameTitle');
    const studentMeta = document.getElementById('studentMeta');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    const statHomework = document.getElementById('statHomework');
    const statTeachers = document.getElementById('statTeachers');
    const statEvents = document.getElementById('statEvents');
    const statMessages = document.getElementById('statMessages');

    const hwGrid = document.getElementById('hwGrid');
    const hwSearch = document.getElementById('hwSearch');
    const hwClassFilter = document.getElementById('hwClassFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const downloadHwBtn = document.getElementById('downloadHwBtn');

    const teachersList = document.getElementById('teachersList');
    const eventsList = document.getElementById('eventsList');
    const noticesList = document.getElementById('noticesList');
    const timetableDiv = document.getElementById('timetable');
    const galleryGrid = document.getElementById('galleryGrid');
    const miniGallery = document.getElementById('miniGallery');
    const quickSearch = document.getElementById('quickSearch');

    const goHomework = document.getElementById('goHomework');
    const openAI = document.getElementById('openAI');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importDataBtn = document.getElementById('importDataBtn');
    const importFile = document.getElementById('importFile');
    const snapshotBtn = document.getElementById('snapshotBtn');
    const themeToggle = document.getElementById('themeToggle');
    const logoutBtn = document.getElementById('logoutBtn');

    const viewMessagesBtn = document.getElementById('viewMessagesBtn');
    const contactBtn = document.getElementById('contactBtn');
    const openGalleryBtn = document.getElementById('openGalleryBtn');
    const adminOpenBtn = document.getElementById('adminOpenBtn');

    const aiFab = document.getElementById('aiFab');
    const aiPanel = document.getElementById('aiPanel');
    const aiClose = document.getElementById('aiClose');
    const aiInput = document.getElementById('aiInput');
    const aiSend = document.getElementById('aiSend');
    const aiMessages = document.getElementById('aiMessages');

    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lbImg');
    const lbClose = document.getElementById('lbClose');

    /* ---------------------------
       Render header student info
       --------------------------- */
    function renderStudentInfo(){
      if(!student) return;
      const name = student.name || (student.email ? student.email.split('@')[0] : 'Student');
      const cls = student.class || '‚Äî';
      const parent = student.parent || student.email || '‚Äî';
      studentNameTitle.textContent = `Welcome, ${name}`;
      studentMeta.textContent = `Class: ${cls} ¬∑ Parent: ${parent}`;
      avatarPlaceholder.textContent = (name.split(' ').slice(0,2).map(s=>s[0]||'').join('') || 'MK').toUpperCase();
    }

    /* ---------------------------
       Populate class filter (1-12)
       --------------------------- */
    function populateClassFilter(){
      hwClassFilter.innerHTML = '<option value="">Show my class (default)</option>';
      for(let i=1;i<=12;i++){
        const opt = document.createElement('option'); opt.value = String(i); opt.textContent = `Class ${i}`;
        hwClassFilter.appendChild(opt);
      }
      if(student && student.class) hwClassFilter.value = student.class;
    }

    /* ---------------------------
       Render Homework for class (reads mkps_homework)
       --------------------------- */
    function renderHomework(search='', clsFilter=''){
      const allHw = storage.get('mkps_homework') || {};
      hwGrid.innerHTML = '';
      // default class is student's class
      const defaultClass = String(student?.class || '');
      const classToShow = clsFilter || defaultClass || '';
      const classes = classToShow ? [classToShow] : Object.keys(allHw).sort();
      let results = [];
      classes.forEach(cl=>{
        const items = allHw[cl] || [];
        items.forEach(it=>{
          const hay = `${it.subject} ${it.teacher} ${it.body} ${it.date} ${cl}`.toLowerCase();
          if(!search || hay.includes(search.toLowerCase())) results.push(Object.assign({ class: cl }, it));
        });
      });
      // sort by date (desc)
      results.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
      document.getElementById('ccHw').textContent = results.length;
      statHomework.textContent = results.length;
      if(results.length === 0){
        hwGrid.innerHTML = `<div class="muted">No homework found for selected class/search.</div>`;
        return;
      }
      results.forEach(item=>{
        const card = document.createElement('article'); card.className='hw-card';
        const meta = document.createElement('div'); meta.className='hw-meta';
        meta.innerHTML = `<div><strong class="hw-title">${item.subject}</strong><div class="hw-sub">Class ${item.class} ¬∑ ${item.date}</div></div>
                          <div style="text-align:right"><span class="pill">${item.teacher||'‚Äî'}</span></div>`;
        const body = document.createElement('div'); body.className='hw-body'; body.textContent = item.body || '';
        const actions = document.createElement('div'); actions.style.marginTop='10px'; actions.style.display='flex'; actions.style.gap='8px';
        const pdfBtn = document.createElement('button'); pdfBtn.className='btn btn-ghost'; pdfBtn.textContent='Download';
        pdfBtn.addEventListener('click', ()=> downloadHomeworkSnapshot([item]));
        const copyBtn = document.createElement('button'); copyBtn.className='btn btn-ghost'; copyBtn.textContent='Copy';
        copyBtn.addEventListener('click', ()=> { navigator.clipboard.writeText(`${item.subject}\n${item.body}`); alert('Copied to clipboard');});
        actions.appendChild(pdfBtn); actions.appendChild(copyBtn);
        card.appendChild(meta); card.appendChild(body); card.appendChild(actions);
        hwGrid.appendChild(card);
      });
    }

    /* ---------------------------
       Render Teachers
       --------------------------- */
    function renderTeachers(){
      const teachers = storage.get('mkps_teachers') || [];
      teachersList.innerHTML = '';
      statTeachers.textContent = teachers.length;
      document.getElementById('ccTeachers').textContent = teachers.length;
      teachers.forEach(t=>{
        const el = document.createElement('div'); el.className='teacher';
        el.innerHTML = `<img alt="${t.name}" src="${t.photo || 'https://placehold.co/200x200?text=Teacher'}">
                        <div style="flex:1"><strong>${t.name}</strong><div class="muted">${t.subject}</div></div>
                        <div style="display:flex;flex-direction:column;gap:6px">
                          <button class="btn btn-ghost" onclick="contactTeacher('${t.name}', '${t.email||''}', '${t.phone||''}')">Contact</button>
                        </div>`;
        teachersList.appendChild(el);
      });
    }

    function contactTeacher(name,email,phone){
      const methods = [];
      if(email) methods.push(`Email: ${email}`);
      if(phone) methods.push(`Phone: ${phone}`);
      alert(`Contact ${name}\n${methods.join('\n') || 'No contact info available.'}`);
    }

    /* ---------------------------
       Render Events
       --------------------------- */
    function renderEvents(){
      const events = storage.get('mkps_events') || [];
      eventsList.innerHTML = '';
      statEvents.textContent = events.length;
      events.forEach(ev=>{
        const div = document.createElement('div'); div.className='event';
        div.innerHTML = `<strong>${ev.title}</strong><div class="muted">${ev.date} ¬∑ ${ev.time} ¬∑ ${ev.location}</div><div style="margin-top:6px">${ev.desc}</div>`;
        eventsList.appendChild(div);
      });
    }

    /* ---------------------------
       Render Notices
       --------------------------- */
    function renderNotices(){
      const notices = storage.get('mkps_notices') || [];
      noticesList.innerHTML = '';
      notices.forEach(n=>{
        const div = document.createElement('div'); div.className = 'notice ' + (n.priority || 'low');
        div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${n.title}</strong><span class="muted">${n.date}</span></div>
                         <div style="margin-top:8px">${n.body}</div>`;
        noticesList.appendChild(div);
      });
      document.getElementById('statMessages').textContent = (storage.get('mkps_messages') || []).length;
    }

    /* ---------------------------
       Render Timetable
       --------------------------- */
    function renderTimetable(){
      const tt = storage.get('mkps_timetable') || {};
      timetableDiv.innerHTML = '';
      const cls = String(student?.class || '');
      const slot = tt[cls];
      if(!slot){
        timetableDiv.innerHTML = '<div class="muted">Timetable not available for your class yet.</div>';
        return;
      }
      const days = ['Mon','Tue','Wed','Thu','Fri'];
      // build a simple grid
      const table = document.createElement('div'); table.style.display='grid'; table.style.gridTemplateColumns='repeat(5,1fr)'; table.style.gap='8px';
      slot.forEach((row, idx) => {
        row.forEach((cell, cidx) => {
          const box = document.createElement('div'); box.style.padding='8px'; box.style.borderRadius='8px'; box.style.background='rgba(255,255,255,0.02)';
          box.textContent = cell;
          table.appendChild(box);
        });
      });
      timetableDiv.appendChild(table);
      document.getElementById('ttMini').textContent = slot.slice(0,2).map(r=>r.join(' | ')).join(' ‚Äî ');
    }

    /* ---------------------------
       Render Gallery
       --------------------------- */
    function renderGallery(){
      const gallery = storage.get('mkps_gallery') || [];
      galleryGrid.innerHTML = '';
      miniGallery.innerHTML = '';
      document.getElementById('ccEvents').textContent = storage.get('mkps_events')?.length || 0;
      gallery.forEach((g,i)=>{
        const img = document.createElement('img'); img.src = g.src; img.alt = g.caption || 'Gallery';
        img.style.cursor='pointer';
        img.addEventListener('click', ()=> openLightbox(g.src));
        galleryGrid.appendChild(img);

        // mini
        const m = document.createElement('img'); m.src = g.src; m.alt = g.caption; m.style.width='100%'; m.style.height='100%';
        m.addEventListener('click', ()=> openLightbox(g.src));
        miniGallery.appendChild(m);
      });
    }

    /* ---------------------------
       Lightbox
       --------------------------- */
    function openLightbox(src){
      lbImg.src = src;
      lb.classList.remove('hidden');
      lb.style.display = 'flex';
      lb.setAttribute('aria-hidden','false');
    }
    lbClose.addEventListener('click', ()=> { lb.classList.add('hidden'); lb.style.display='none'; lb.setAttribute('aria-hidden','true'); });

    /* ---------------------------
       Download snapshot of homework (simple HTML)
       --------------------------- */
    function downloadHomeworkSnapshot(items){
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>Homework Snapshot</title>
      <style>body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#111} .card{border:1px solid #ddd;padding:12px;margin-bottom:8px;border-radius:8px}</style></head><body>
      <h1>Homework Snapshot ‚Äî ${new Date().toLocaleString()}</h1>
      ${items.map(it=>`<div class="card"><h2>${it.subject} ‚Äî Class ${it.class}</h2><div><strong>Date:</strong> ${it.date}</div><div><strong>Teacher:</strong> ${it.teacher}</div><p>${it.body}</p></div>`).join('')}
      </body></html>`;
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'mkps_homework_snapshot.html'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* ---------------------------
       Export / Import data (JSON)
       --------------------------- */
    function exportData(){
      const keys = ['mkps_homework','mkps_teachers','mkps_events','mkps_notices','mkps_timetable','mkps_gallery','mkps_messages','mkps_meta'];
      const out = {};
      keys.forEach(k=> out[k] = safeParse(localStorage.getItem(k), null));
      const blob = new Blob([JSON.stringify(out,null,2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `mkps_export_${(new Date()).toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function importDataFromFile(file){
      const reader = new FileReader();
      reader.onload = function(e){
        try{
          const parsed = JSON.parse(e.target.result);
          Object.keys(parsed).forEach(k=>{
            if(parsed[k] === null) localStorage.removeItem(k);
            else localStorage.setItem(k, JSON.stringify(parsed[k]));
          });
          localStorage.setItem('mkps_update', now());
          alert('Import successful. Refreshing view.');
          refreshAll();
        }catch(err){
          alert('Import failed: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    /* ---------------------------
       AI Study Helper (calls Google Generative Language)
       - This function attempts keys in AI_KEYS sequentially.
       - It sends a system instruction forcing study-only answers.
       --------------------------- */
    async function askStudyAI(question){
      const system = `You are a helpful study assistant for school students of Milli Karwaan Public School. Only answer academic/study questions. Provide step-by-step explanations, examples, short practice tasks, and emoji support. Keep answers safe and age-appropriate.`;
      const content = `${system}\n\nStudent question: ${question}`;
      const body = { contents: [ { parts: [ { text: content } ] } ] };
      let lastErr = null;
      for(const key of AI_KEYS){
        try{
          const res = await fetch(`${GEN_API}?key=${key}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          if(!res.ok){
            const txt = await res.text();
            lastErr = new Error('AI error: ' + res.status + ' ' + txt);
            continue; // try next key
          }
          const data = await res.json();
          // find text in response
          const text = (data?.candidates?.[0]?.content?.parts?.[0]?.text) || (data?.output?.[0]?.content?.[0]?.text) || JSON.stringify(data);
          return text;
        }catch(err){
          lastErr = err;
          // try next key
        }
      }
      throw lastErr || new Error('All AI keys failed or network error.');
    }

    /* ---------------------------
       AI UI handlers
       --------------------------- */
    aiFab.addEventListener('click', ()=> {
      aiPanel.classList.toggle('hidden'); aiPanel.style.display = aiPanel.classList.contains('hidden') ? 'none' : 'flex';
      aiInput.focus();
    });
    aiClose.addEventListener('click', ()=> { aiPanel.classList.add('hidden'); aiPanel.style.display='none'; });
    aiSend.addEventListener('click', handleAiSend);
    aiInput.addEventListener('keydown', (e)=> { if(e.key==='Enter'){ e.preventDefault(); handleAiSend(); }});

    async function handleAiSend(){
      const q = aiInput.value.trim(); if(!q) return;
      appendAiMessage('you', q);
      aiInput.value = ''; aiInput.disabled = true; aiSend.disabled = true;
      try{
        const ans = await askStudyAI(q);
        appendAiMessage('ai', ans);
      }catch(err){
        appendAiMessage('ai', 'Sorry, AI failed: ' + (err.message || err));
      } finally {
        aiInput.disabled = false; aiSend.disabled = false;
      }
    }

    function appendAiMessage(who, text){
      const el = document.createElement('div'); el.style.marginBottom='8px';
      if(who==='you'){
        el.innerHTML = `<div style="text-align:right"><div style="display:inline-block;background:linear-gradient(90deg,#234 20%,#346);padding:8px;border-radius:8px;color:#fff">${escapeHtml(text)}</div></div>`;
      } else {
        el.innerHTML = `<div style="text-align:left"><div style="display:inline-block;background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:#eaf2fb">${escapeHtml(text)}</div></div>`;
      }
      aiMessages.appendChild(el); aiMessages.scrollTop = aiMessages.scrollHeight;
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    /* ---------------------------
       Quick functions and bindings
       --------------------------- */
    refreshBtn.addEventListener('click', ()=> refreshAll());
    downloadHwBtn.addEventListener('click', ()=> {
      // download visible homework
      const visible = Array.from(document.querySelectorAll('#hwGrid .hw-card')).map(card=>{
        return {
          subject: card.querySelector('.hw-title')?.innerText || '',
          body: card.querySelector('.hw-body')?.innerText || '',
          meta: card.querySelector('.hw-sub')?.innerText || ''
        };
      });
      if(visible.length===0) return alert('No homework visible to snapshot.');
      // convert visible to similar structure for download
      const items = visible.map((v,i)=> ({ id: uid(6), date: new Date().toISOString().slice(0,10), subject: v.subject, teacher: '', class: '', body: v.body }));
      downloadHomeworkSnapshot(items);
    });

    exportDataBtn.addEventListener('click', exportData);
    importDataBtn.addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', (e)=> {
      if(e.target.files.length>0) importDataFromFile(e.target.files[0]);
    });
    snapshotBtn.addEventListener('click', ()=> {
      // Snapshot entire dashboard (HTML)
      const html = document.documentElement.outerHTML;
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'mkps_dashboard_snapshot.html'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    themeToggle.addEventListener('click', ()=> {
      document.body.classList.toggle('light');
    });

    logoutBtn.addEventListener('click', ()=> {
      if(confirm('Logout?')){ localStorage.removeItem('mkps_student'); location.href='index.html'; }
    });

    viewMessagesBtn.addEventListener('click', ()=> {
      const msgs = storage.get('mkps_messages') || [];
      const txt = msgs.length ? msgs.map(m=> `${m.date}\n${m.name || 'Visitor'}: ${m.message}`).join('\n\n') : 'No messages saved.';
      alert(txt);
    });

    contactBtn.addEventListener('click', ()=> {
      location.href = 'mailto:madamsir066@gmail.com?subject=Contact%20MKPS';
    });

    openGalleryBtn.addEventListener('click', ()=> {
      // open first image in lightbox
      const gallery = storage.get('mkps_gallery') || [];
      if(gallery.length>0) openLightbox(gallery[0].src);
      else alert('Gallery is empty');
    });

    adminOpenBtn.addEventListener('click', ()=> {
      const pass = prompt('Admin password (hidden):');
      if(pass === 'Abutalha'){
        // admin.html is expected to be created later ‚Äî open if exists
        window.open('admin.html','_blank');
      } else {
        alert('Incorrect admin password');
      }
    });

    quickSearch.addEventListener('input', (e)=> {
      const q = e.target.value.trim().toLowerCase();
      if(!q) { renderHomework('', hwClassFilter.value); renderTeachers(); renderNotices(); return; }
      renderHomework(q, ''); // search across all classes
    });

    hwSearch.addEventListener('input', (e)=> {
      renderHomework(e.target.value.trim(), hwClassFilter.value);
    });

    hwClassFilter.addEventListener('change', (e)=> {
      renderHomework(hwSearch.value.trim(), e.target.value);
    });

    goHomework.addEventListener('click', ()=> {
      window.scrollTo({ top: 300, behavior: 'smooth' });
    });

    openAI.addEventListener('click', ()=> {
      aiPanel.classList.remove('hidden'); aiPanel.style.display='flex'; aiInput.focus();
    });

    // storage event for admin.html updates
    window.addEventListener('storage', (e)=> {
      if(e.key === 'mkps_update'){
        console.log('mkps_update changed ‚Äî refreshing');
        refreshAll();
      }
    });

    /* ---------------------------
       Expose admin helper functions (for admin.html later)
       --------------------------- */
    window.renderHomeworkFor = function(cls){
      hwClassFilter.value = String(cls); renderHomework('', String(cls));
    };
    window.refreshTeachers = function(){ renderTeachers(); };
    window.refreshEvents = function(){ renderEvents(); };
    window.refreshNotices = function(){ renderNotices(); };
    window.refreshTimetable = function(){ renderTimetable(); };
    window.refreshGallery = function(){ renderGallery(); };
    window.refreshMessages = function(){ /* admin can read mkps_messages */ };
    window.exportMkpsData = exportData;

    /* ---------------------------
       Refresh all UI
       --------------------------- */
    function refreshAll(){
      renderStudentInfo();
      populateClassFilter();
      renderHomework('', hwClassFilter.value || '');
      renderTeachers();
      renderEvents();
      renderNotices();
      renderTimetable();
      renderGallery();
      // update top stats
      const meta = storage.get('mkps_meta') || {};
      document.getElementById('achvCount').textContent = meta.achievements || '‚Äî';
      document.getElementById('attendancePercent').textContent = meta.attendancePercent ? meta.attendancePercent + '%' : '‚Äî';
      document.getElementById('avgScore').textContent = meta.avgScore || '‚Äî';
    }

    // Initial render
    refreshAll();

    /* ---------------------------
       Small helpers / fallbacks
       --------------------------- */
    window.addEventListener('beforeunload', ()=>{ /* could save temp state if needed */ });

    // Helpful console note
    console.log('MKPS Dashboard loaded. Admin hooks: window.renderHomeworkFor(), window.refreshTeachers(), window.refreshEvents(), window.exportMkpsData(). Admin password: Abutalha (use admin.html when ready).');

    // Accessibility: close lightbox / ai with Escape
    document.addEventListener('keydown', (e)=> {
      if(e.key === 'Escape'){
        if(!lb.classList.contains('hidden')) { lb.classList.add('hidden'); lb.style.display='none'; }
        if(!aiPanel.classList.contains('hidden')) { aiPanel.classList.add('hidden'); aiPanel.style.display='none'; }
      }
    });

    // End of script
  </script>
</body>
</html>
