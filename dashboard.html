<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Dashboard - MKPS</title>
  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #f8f9ff;
      color: #333;
      min-height: 100vh;
      padding: 0;
      margin: 0;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      background: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #1e3c72;
      color: #fff;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo i {
      color: #4facfe;
    }

    .profile-icon {
      background: #fff;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1e3c72;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    main {
      flex: 1;
      padding: 20px;
      background: #f0f4ff;
      position: relative;
    }

    .welcome-card {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 20px rgba(37, 117, 252, 0.2);
    }

    .welcome-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .student-name {
      font-size: 1.3rem;
      font-weight: 600;
    }

    .student-class {
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      display: inline-block;
      margin-top: 5px;
    }

    .profile-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.5rem;
    }

    .quick-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      text-align: center;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      margin: 0 auto 8px;
    }

    .attendance-icon { background: #d4edda; color: #155724; }
    .fees-icon { background: #fff3cd; color: #856404; }
    .homework-icon { background: #d1ecf1; color: #0c5460; }

    .stat-title {
      font-size: 0.9rem;
      color: #666;
      margin: 0;
    }

    .stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 5px 0;
    }

    .tabs {
      display: flex;
      background: white;
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      overflow: auto;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab.active {
      background: #2575fc;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e3c72;
      margin: 20px 0 15px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title i {
      background: #e6f0ff;
      width: 30px;
      height: 30px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2575fc;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      overflow: hidden;
      margin-bottom: 15px;
    }

    .item {
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .item:last-child {
      border-bottom: none;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .subject, .title, .period {
      font-weight: 600;
      color: #1e3c72;
    }

    .date, .time, .teacher {
      font-size: 0.85rem;
      color: #666;
    }

    .description, .content {
      font-size: 0.95rem;
      line-height: 1.5;
      color: #555;
      margin: 8px 0;
    }

    .status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-top: 8px;
    }

    .status-paid { background: #d4edda; color: #155724; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-overdue { background: #f8d7da; color: #721c24; }

    .timetable {
      width: 100%;
      border-collapse: collapse;
    }

    .timetable th {
      background: #1e3c72;
      color: white;
      padding: 12px;
      text-align: left;
    }

    .timetable td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    .timetable tr:nth-child(even) {
      background: #f8f9ff;
    }

    .timetable .time-col {
      width: 80px;
      font-weight: 600;
      color: #1e3c72;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-state i {
      font-size: 3rem;
      color: #ddd;
      margin-bottom: 15px;
    }

    .empty-state p {
      margin: 10px 0;
    }

    .ai-assistant {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1e3c72;
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s ease;
    }

    .ai-assistant:hover {
      transform: scale(1.1);
      background: #2575fc;
    }

    .ai-assistant i {
      font-size: 1.5rem;
    }

    .menu {
      display: flex;
      justify-content: space-around;
      background: white;
      padding: 12px 0;
      border-top: 1px solid #eee;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .menu-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #666;
      font-size: 0.85rem;
      transition: color 0.3s;
    }

    .menu-item.active {
      color: #2575fc;
    }

    .menu-item i {
      font-size: 1.3rem;
      margin-bottom: 4px;
    }

    .skeleton {
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 12px;
      animation: pulse 1.5s infinite ease-in-out;
    }

    .skeleton-header {
      height: 80px;
      border-radius: 16px;
      margin-bottom: 20px;
      background: #f8f9fa;
      animation: pulse 1.5s infinite ease-in-out;
    }

    .skeleton:nth-child(1) { height: 60px; }
    .skeleton:nth-child(2) { height: 60px; }
    .skeleton:nth-child(3) { height: 60px; }
    .skeleton:nth-child(4) { height: 100px; }
    .skeleton:nth-child(5) { height: 80px; }

    @keyframes pulse {
      0% { opacity: 0.8; }
      50% { opacity: 0.5; }
      100% { opacity: 0.8; }
    }

    .loader {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2575fc;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1e3c72;
    }

    .close-btn {
      background: #f8f9fa;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      color: #666;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .note-content {
      line-height: 1.6;
      color: #555;
      white-space: pre-wrap;
    }

    @media (max-width: 480px) {
      .quick-stats {
        grid-template-columns: 1fr;
      }
      
      .welcome-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .profile-avatar {
        margin-top: 10px;
      }
      
      .tabs {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-school"></i>
        <span>MKPS Balrampur</span>
      </div>
      <div class="profile-icon" id="profileBtn">A</div>
    </header>

    <main id="mainContent">
      <div class="skeleton-header"></div>
      
      <div class="quick-stats">
        <div class="stat-card">
          <div class="stat-icon attendance-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <h3 class="stat-title">Attendance</h3>
          <p class="stat-value">Loading...</p>
        </div>
        <div class="stat-card">
          <div class="stat-icon homework-icon">
            <i class="fas fa-book"></i>
          </div>
          <h3 class="stat-title">Homework</h3>
          <p class="stat-value">Loading...</p>
        </div>
        <div class="stat-card">
          <div class="stat-icon fees-icon">
            <i class="fas fa-rupee-sign"></i>
          </div>
          <h3 class="stat-title">Fees</h3>
          <p class="stat-value">Loading...</p>
        </div>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="homework">
          <i class="fas fa-book"></i> Homework
        </div>
        <div class="tab" data-tab="notes">
          <i class="fas fa-sticky-note"></i> Notes
        </div>
        <div class="tab" data-tab="timetable">
          <i class="fas fa-clock"></i> Timetable
        </div>
        <div class="tab" data-tab="announcements">
          <i class="fas fa-bullhorn"></i> Announcements
        </div>
      </div>

      <div id="content">
        <!-- Homework Tab -->
        <div class="tab-content active" id="homework">
          <div class="skeleton"></div>
          <div class="skeleton"></div>
          <div class="skeleton"></div>
        </div>

        <!-- Notes Tab -->
        <div class="tab-content" id="notes">
          <div class="skeleton"></div>
          <div class="skeleton"></div>
          <div class="skeleton"></div>
        </div>

        <!-- Timetable Tab -->
        <div class="tab-content" id="timetable">
          <div class="skeleton"></div>
          <div class="skeleton"></div>
          <div class="skeleton"></div>
        </div>

        <!-- Announcements Tab -->
        <div class="tab-content" id="announcements">
          <div class="skeleton"></div>
          <div class="skeleton"></div>
        </div>
      </div>

      <div class="loader" id="loader">
        <div class="spinner"></div>
        <div style="margin-top:10px; font-size:0.9rem; color:#555;">Loading dashboard...</div>
      </div>
    </main>

    <div class="menu">
      <div class="menu-item active">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </div>
      <div class="menu-item">
        <i class="fas fa-book"></i>
        <span>Homework</span>
      </div>
      <div class="menu-item">
        <i class="fas fa-file-alt"></i>
        <span>Notes</span>
      </div>
      <div class="menu-item">
        <i class="fas fa-comments"></i>
        <span>Messages</span>
      </div>
      <div class="menu-item">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </div>
    </div>

    <div class="ai-assistant" id="aiBtn">
      <i class="fas fa-robot"></i>
    </div>

    <!-- Note Modal -->
    <div class="modal" id="noteModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Note Details</h3>
          <button class="close-btn" id="closeNoteModal">&times;</button>
        </div>
        <div class="modal-body">
          <h4 id="noteTitle" style="margin-bottom: 10px; color: #1e3c72;"></h4>
          <p id="noteDate" style="color: #666; font-size: 0.9rem; margin-bottom: 15px;"></p>
          <div class="note-content" id="noteContent"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB0fHtqeoerlckQ2RXx_VC86cZz_BJaIIU",
      authDomain: "mkps-balrampur.firebaseapp.com",
      projectId: "mkps-balrampur",
      storageBucket: "mkps-balrampur.firebasestorage.app",
      messagingSenderId: "469227187804",
      appId: "1:469227187804:web:8abdb9b75ed05b7eadc099",
      measurementId: "G-TYKBNS9SX2"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // DOM Elements
    const mainContent = document.getElementById('mainContent');
    const loader = document.getElementById('loader');
    const profileBtn = document.getElementById('profileBtn');
    const aiBtn = document.getElementById('aiBtn');
    const tabs = document.getElementById('tabs');
    const tabContents = document.querySelectorAll('.tab-content');
    const noteModal = document.getElementById('noteModal');
    const closeNoteModal = document.getElementById('closeNoteModal');

    // Student Data
    let studentData = null;
    let homeworkData = [];
    let notesData = [];
    let timetableData = {};
    let announcementData = [];

    // Timetable configuration by class
    const timetableConfig = {
      'Nursery': {
        '09:00': ['Rhymes', 'Art & Craft', 'Play Time'],
        '10:00': ['Story Time', 'Math', 'English'],
        '11:00': ['Moral Science', 'Free Period', 'Lunch']
      },
      'LKG': {
        '09:00': ['English', 'Math', 'EVS'],
        '10:00': ['Hindi', 'Art & Craft', 'Music'],
        '11:00': ['Games', 'Story Time', 'Lunch']
      },
      'UKG': {
        '09:00': ['English', 'Math', 'EVS'],
        '10:00': ['Hindi', 'Art & Craft', 'Music'],
        '11:00': ['Games', 'Computer', 'Lunch']
      },
      '1': {
        '09:00': ['English', 'Math', 'EVS'],
        '10:00': ['Hindi', 'Art & Craft', 'Music'],
        '11:00': ['Games', 'Computer', 'Lunch']
      },
      '2': {
        '09:00': ['English', 'Math', 'EVS'],
        '10:00': ['Hindi', 'Art & Craft', 'Music'],
        '11:00': ['Games', 'Computer', 'Lunch']
      },
      '3': {
        '09:00': ['English', 'Math', 'Science'],
        '10:00': ['Hindi', 'Social Studies', 'Art'],
        '11:00': ['Games', 'Computer', 'Lunch']
      },
      '4': {
        '09:00': ['English', 'Math', 'Science'],
        '10:00': ['Hindi', 'Social Studies', 'Art'],
        '11:00': ['Games', 'Computer', 'Lunch']
      },
      '5': {
        '09:00': ['English', 'Math', 'Science'],
        '10:00': ['Hindi', 'Social Studies', 'Art'],
        '11:00': ['Games', 'Computer', 'Lunch']
      },
      '6': {
        '09:00': ['English', 'Math', 'Science'],
        '10:00': ['Hindi', 'Social Studies', 'Sanskrit'],
        '11:00': ['Games', 'Computer', 'Lunch']
      },
      '7': {
        '09:00': ['English', 'Math', 'Science'],
        '10:00': ['Hindi', 'Social Studies', 'Sanskrit'],
        '11:00': ['Games', 'Computer', 'Lunch']
      },
      '8': {
        '09:00': ['English', 'Math', 'Science'],
        '10:00': ['Hindi', 'Social Studies', 'Sanskrit'],
        '11:00': ['Games', 'Computer', 'Lunch']
      }
    };

    // Show Loader
    function showLoader(show) {
      loader.style.display = show ? 'block' : 'none';
    }

    // Get Session Data
    function getSession() {
      const session = localStorage.getItem('mkps_session');
      if (!session) {
        alert('No session found. Please login first.');
        window.location.href = 'index.html';
        return null;
      }
      return JSON.parse(session);
    }

    // Format Date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: '2-digit'
      });
    }

    // Format Date for display
    function formatDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: '2-digit'
      }) + ' ' + date.toLocaleTimeString('en-IN', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Load Student Data
    async function loadStudentData() {
      const session = getSession();
      if (!session || session.role !== 'student') return;

      studentData = session.data;
      
      // Update profile
      document.querySelector('.student-name').textContent = studentData.name;
      document.querySelector('.student-class').textContent = `Class ${studentData.class}`;
      
      // Update profile avatar
      const firstLetter = studentData.name.charAt(0).toUpperCase();
      document.getElementById('profileAvatar').textContent = firstLetter;
      document.getElementById('profileBtn').textContent = firstLetter;

      // Mock attendance data
      const totalDays = 100;
      const presentDays = Math.floor(Math.random() * 20) + 80; // 80-100%
      const attendanceRate = Math.round((presentDays / totalDays) * 100);
      document.querySelector('.stat-value:nth-child(1)').textContent = `${attendanceRate}%`;

      // Load homework
      await loadHomework();
      
      // Load notes
      await loadNotes();
      
      // Load timetable
      loadTimetable();
      
      // Load announcements
      await loadAnnouncements();
    }

    // Load Homework
    async function loadHomework() {
      try {
        const homeworkRef = await db.collection('homework')
          .where('class', '==', studentData.class)
          .orderBy('date', 'desc')
          .limit(10)
          .get();

        const homeworkList = document.getElementById('homework');
        homeworkList.innerHTML = '';

        if (homeworkRef.empty) {
          // Add some mock homework if none in database
          const mockHomework = [
            { subject: 'Math', description: 'Complete exercise 3.2 on fractions', date: new Date().toISOString() },
            { subject: 'English', description: 'Write a paragraph about your favorite book', date: new Date(Date.now() - 86400000).toISOString() },
            { subject: 'Science', description: 'Draw and label the parts of a plant', date: new Date(Date.now() - 172800000).toISOString() }
          ];

          mockHomework.forEach(hw => {
            const homeworkItem = document.createElement('div');
            homeworkItem.className = 'card';
            homeworkItem.innerHTML = `
              <div class="item">
                <div class="item-header">
                  <span class="subject">${hw.subject}</span>
                  <span class="date">${formatDate(hw.date)}</span>
                </div>
                <p class="description">${hw.description}</p>
              </div>
            `;
            homeworkList.appendChild(homeworkItem);
          });

          document.querySelector('.stat-value:nth-child(2)').textContent = mockHomework.length;
          return;
        }

        homeworkData = [];
        let count = 0;
        homeworkRef.forEach(doc => {
          const data = doc.data();
          homeworkData.push({ id: doc.id, ...data });
          
          const homeworkItem = document.createElement('div');
          homeworkItem.className = 'card';
          homeworkItem.innerHTML = `
            <div class="item">
              <div class="item-header">
                <span class="subject">${data.subject}</span>
                <span class="date">${formatDate(data.date)}</span>
              </div>
              <p class="description">${data.description}</p>
            </div>
          `;
          homeworkList.appendChild(homeworkItem);
          count++;
        });

        document.querySelector('.stat-value:nth-child(2)').textContent = count;
      } catch (error) {
        console.error('Error loading homework:', error);
        document.getElementById('homework').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Error loading homework</p>
          </div>
        `;
      }
    }

    // Load Notes
    async function loadNotes() {
      try {
        const notesRef = await db.collection('notes')
          .where('class', '==', studentData.class)
          .orderBy('date', 'desc')
          .limit(10)
          .get();

        const notesList = document.getElementById('notes');
        notesList.innerHTML = '';

        if (notesRef.empty) {
          // Add some mock notes if none in database
          const mockNotes = [
            { title: 'Math - Fractions', content: 'A fraction represents a part of a whole. Numerator is the top number, denominator is the bottom number.', date: new Date().toISOString() },
            { title: 'English - Tenses', content: 'There are three main tenses: Present, Past, and Future. Each has simple, continuous, perfect, and perfect continuous forms.', date: new Date(Date.now() - 86400000).toISOString() },
            { title: 'Science - Plants', content: 'Plants make their own food through photosynthesis. They need sunlight, water, and carbon dioxide to survive.', date: new Date(Date.now() - 172800000).toISOString() }
          ];

          mockNotes.forEach(note => {
            const noteItem = document.createElement('div');
            noteItem.className = 'card';
            noteItem.innerHTML = `
              <div class="item" data-note='${JSON.stringify(note)}'>
                <div class="item-header">
                  <span class="title">${note.title}</span>
                  <span class="date">${formatDate(note.date)}</span>
                </div>
                <p class="content">${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}</p>
              </div>
            `;
            noteItem.querySelector('.item').addEventListener('click', () => {
              openNoteModal(note);
            });
            notesList.appendChild(noteItem);
          });
          return;
        }

        notesData = [];
        notesRef.forEach(doc => {
          const data = doc.data();
          notesData.push({ id: doc.id, ...data });
          
          const noteItem = document.createElement('div');
          noteItem.className = 'card';
          noteItem.innerHTML = `
            <div class="item" data-note='${JSON.stringify(data)}'>
              <div class="item-header">
                <span class="title">${data.title}</span>
                <span class="date">${formatDate(data.date)}</span>
              </div>
              <p class="content">${data.content.substring(0, 100)}${data.content.length > 100 ? '...' : ''}</p>
            </div>
          `;
          noteItem.querySelector('.item').addEventListener('click', () => {
            openNoteModal(data);
          });
          notesList.appendChild(noteItem);
        });
      } catch (error) {
        console.error('Error loading notes:', error);
        document.getElementById('notes').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Error loading notes</p>
          </div>
        `;
      }
    }

    // Open Note Modal
    function openNoteModal(note) {
      document.getElementById('noteTitle').textContent = note.title;
      document.getElementById('noteDate').textContent = `Posted on ${formatDateTime(note.date)}`;
      document.getElementById('noteContent').textContent = note.content;
      noteModal.style.display = 'flex';
    }

    // Load Timetable
    function loadTimetable() {
      const timetableList = document.getElementById('timetable');
      timetableList.innerHTML = '';

      const classTimetable = timetableConfig[studentData.class] || timetableConfig['1'];
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
      
      const table = document.createElement('table');
      table.className = 'timetable';
      
      // Header
      let headerRow = '<tr><th>Time</th>';
      days.forEach(day => {
        headerRow += `<th>${day}</th>`;
      });
      headerRow += '</tr>';
      table.innerHTML = headerRow;

      // Content
      Object.keys(classTimetable).forEach(time => {
        let row = `<tr><td class="time-col">${time}</td>`;
        classTimetable[time].forEach(subject => {
          row += `<td>${subject}</td>`;
        });
        row += '</tr>';
        table.innerHTML += row;
      });

      timetableList.appendChild(table);
    }

    // Load Announcements
    async function loadAnnouncements() {
      try {
        const announcementRef = await db.collection('announcements')
          .orderBy('date', 'desc')
          .limit(5)
          .get();

        const announcementList = document.getElementById('announcements');
        announcementList.innerHTML = '';

        if (announcementRef.empty) {
          // Add some mock announcements if none in database
          const mockAnnouncements = [
            { message: 'School will remain closed on Monday for Diwali celebrations.', date: new Date().toISOString() },
            { message: 'Parent-Teacher meeting scheduled for next Friday at 3 PM.', date: new Date(Date.now() - 86400000).toISOString() },
            { message: 'New library books have arrived. Students can borrow from tomorrow.', date: new Date(Date.now() - 172800000).toISOString() }
          ];

          mockAnnouncements.forEach(ann => {
            const announcementItem = document.createElement('div');
            announcementItem.className = 'card';
            announcementItem.innerHTML = `
              <div class="item">
                <div class="item-header">
                  <span class="subject">Announcement</span>
                  <span class="date">${formatDate(ann.date)}</span>
                </div>
                <p class="description">${ann.message}</p>
              </div>
            `;
            announcementList.appendChild(announcementItem);
          });
          return;
        }

        announcementData = [];
        announcementRef.forEach(doc => {
          const data = doc.data();
          announcementData.push({ id: doc.id, ...data });
          
          const announcementItem = document.createElement('div');
          announcementItem.className = 'card';
          announcementItem.innerHTML = `
            <div class="item">
              <div class="item-header">
                <span class="subject">Announcement</span>
                <span class="date">${formatDate(data.date)}</span>
              </div>
              <p class="description">${data.message}</p>
            </div>
          `;
          announcementList.appendChild(announcementItem);
        });
      } catch (error) {
        console.error('Error loading announcements:', error);
        document.getElementById('announcements').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Error loading announcements</p>
          </div>
        `;
      }
    }

    // Mock fees data
    function loadFees() {
      const feesAmount = 5000;
      const paidAmount = Math.random() > 0.3 ? 3000 : 0; // 70% chance of partial payment
      const feesPercentage = (paidAmount / feesAmount) * 100;
      document.querySelector('.stat-value:nth-child(3)').textContent = `‚Çπ${feesAmount.toLocaleString()}`;
      
      const feesStatusEl = document.createElement('span');
      feesStatusEl.className = 'status';
      if (paidAmount === 0) {
        feesStatusEl.textContent = 'Overdue';
        feesStatusEl.classList.add('status-overdue');
      } else if (paidAmount < feesAmount) {
        feesStatusEl.textContent = 'Pending';
        feesStatusEl.classList.add('status-pending');
      } else {
        feesStatusEl.textContent = 'Paid';
        feesStatusEl.classList.add('status-paid');
      }
      
      const feesCard = document.querySelector('.stat-card:nth-child(3)');
      const existingStatus = feesCard.querySelector('.status');
      if (existingStatus) {
        existingStatus.remove();
      }
      feesCard.appendChild(feesStatusEl);
    }

    // Tab Switching
    tabs.addEventListener('click', (e) => {
      if (e.target.closest('.tab')) {
        const tab = e.target.closest('.tab');
        const tabName = tab.getAttribute('data-tab');
        
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => {
          t.classList.remove('active');
        });
        tab.classList.add('active');
        
        // Show active content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');
      }
    });

    // Initialize App
    async function initApp() {
      showLoader(true);

      try {
        await loadStudentData();
        loadFees(); // Load fees data
        
        // Hide skeletons and show content
        document.querySelector('.skeleton-header').style.display = 'none';
        document.querySelectorAll('.skeleton').forEach(el => {
          el.style.display = 'none';
        });
        
        showLoader(false);
      } catch (error) {
        console.error('Error initializing app:', error);
        showLoader(false);
        alert('Error loading dashboard: ' + error.message);
      }
    }

    // Event Listeners
    profileBtn.addEventListener('click', () => {
      if (confirm('Do you want to logout?')) {
        localStorage.removeItem('mkps_session');
        window.location.href = 'index.html';
      }
    });

    aiBtn.addEventListener('click', () => {
      window.location.href = 'ai.html';
    });

    closeNoteModal.addEventListener('click', () => {
      noteModal.style.display = 'none';
    });

    window.addEventListener('click', (e) => {
      if (e.target === noteModal) {
        noteModal.style.display = 'none';
      }
    });

    // Check if user is logged in
    document.addEventListener('DOMContentLoaded', () => {
      const session = getSession();
      if (!session || session.role !== 'student') {
        window.location.href = 'index.html';
        return;
      }
      
      initApp();
    });

    // Mock Gemini AI Integration
    window.geminiAI = {
      async askQuestion(question) {
        const apiKey = 'AIzaSyCdzFBQ1KVgBfmmjSgHJJwcuLbqne9VjUs';
        try {
          // This would be the actual API call
          const responses = [
            "I understand your question about homework. Let me explain this concept clearly with examples from your textbook...",
            "Based on your class level, here's a simple explanation using real-life examples you can relate to...",
            "This is an important concept in your curriculum. Let me break it down step by step with a diagram...",
            "Great question! Here's how this applies to your studies, with some practice problems to try...",
            "I can help you with that! Let me provide a detailed explanation with emojis to make it more engaging üåüüìö‚úèÔ∏è"
          ];
          return responses[Math.floor(Math.random() * responses.length)];
        } catch (error) {
          return "I'm having trouble connecting to the AI service right now. Please try again later.";
        }
      }
    };
  </script>
</body>
</html>
