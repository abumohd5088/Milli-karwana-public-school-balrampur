<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MKPS Student Hub ‚Äì Professional</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --primary:#667eea;
      --secondary:#764ba2;
      --bg:#f5f7fa;
      --card:#ffffff;
      --text:#333333;
      --muted:#777777;
      --success:#2e7d32;
      --warning:#ef6c00;
      --danger:#c62828;
      --shadow:0 4px 20px rgba(0,0,0,.08);
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif}
    body{background:var(--bg);color:var(--text);min-height:100vh;scroll-behavior:smooth}
    /* Header */
    .header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
    .header h2{font-size:22px;font-weight:600}
    .logout{background:rgba(255,255,255,.25);border:none;color:#fff;border-radius:20px;padding:8px 12px;font-size:12px}
    /* Welcome */
    .welcome{background:var(--card);margin:12px 16px;border-radius:22px;padding:20px;text-align:center;box-shadow:var(--shadow)}
    .welcome h3{font-size:18px;font-weight:600}
    /* Stats Grid */
    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:12px 16px}
    .stat-card{background:var(--card);border-radius:18px;padding:15px;text-align:center;box-shadow:var(--shadow)}
    .stat-card b{font-size:20px;color:var(--primary)}
    /* Section */
    .section{margin:25px 0}
    .section-title{display:flex;justify-content:space-between;align-items:center;padding:0 20px 12px;font-size:16px;font-weight:600}
    .section-title a{color:var(--primary);font-size:11px;text-decoration:none}
    .scroll{display:flex;gap:12px;padding:0 20px;overflow-x:auto;scroll-snap-type:x mandatory}
    .card{flex:0 0 85%;background:var(--card);border-radius:20px;padding:18px;box-shadow:var(--shadow);scroll-snap-align:start}
    .card h4{font-size:15px;font-weight:600;margin-bottom:6px}
    .card p{font-size:13px;color:var(--muted)}
    .small{font-size:11px;color:var(--muted)}
    /* Status Pills */
    .pill{display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;margin-top:6px}
    .pending{background:#fff3cd;color:#856404}
    .completed{background:#d1e7dd;color:#0f5132}
    .overdue{background:#f8d7da;color:#721c24}
    /* Tables */
    .table-wrap{margin:0 20px;background:var(--card);border-radius:18px;overflow:hidden}
    table{width:100%;font-size:13px;border-collapse:collapse}
    th,td{padding:12px 5px;text-align:center;border-bottom:1px solid #eee}
    /* Bottom Navigation */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);display:flex;border-top:1px solid #eee;height:60px}
    .nav-item{flex:1;text-align:center;padding-top:8px;font-size:11px;color:var(--muted);cursor:pointer;transition:.2s}
    .nav-item.active{color:var(--primary);font-weight:600}
    .nav-item i{font-size:20px;margin-bottom:2px}
    /* FAB */
    .fab{position:fixed;bottom:80px;right:20px;background:var(--primary);color:#fff;width:58px;height:58px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 5px 15px rgba(0,0,0,.25);z-index:1000}
    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:var(--card);border-radius:20px;padding:20px;width:90%;max-height:80%;overflow-y:auto}
    .close{float:right;font-size:24px;cursor:pointer;color:var(--muted)}
    /* Empty / Loading */
    .empty{text-align:center;padding:40px;color:var(--muted)}
    .loading{text-align:center;padding:30px;color:var(--primary)}
    /* Chart Container */
    .chart-container{position:relative;height:160px;margin:0 20px}
  </style>
</head>
<body>

<!-- Header -->
<header>
  <h2><i class="fas fa-user-graduate"></i> Welcome, <span id="stuName">Student</span></h2>
  <button class="logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
</header>

<!-- Personalized Welcome -->
<div class="welcome">
  <h3>Hi, <span id="stuFull">--</span> üëã</h3>
  <p>Class: <b id="stuClass">--</b> | Roll: <b id="stuRoll">--</b></p>
</div>

<!-- Quick Stats Grid -->
<div class="stats">
  <div class="stat-card"><b id="attPer">--</b><br>Attendance</div>
  <div class="stat-card"><b id="hwPen">--</b><br>Pending HW</div>
  <div class="stat-card"><b id="notesCnt">--</b><br>Notes</div>
  <div class="stat-card"><b id="events">--</b><br>Events</div>
</div>

<!-- Homework -->
<section class="section">
  <div class="section-title"><span><i class="fas fa-book"></i> Today's Homework</span><a href="#" onclick="openModal('hw')">View All</a></div>
  <div class="scroll" id="homework-list"><div class="loading"><i class="fas fa-spinner fa-spin"></i></div></div>
</section>

<!-- Notes -->
<section class="section">
  <div class="section-title">
    <span><i class="fas fa-sticky-note"></i> Notes</span>
    <label style="color:var(--primary);cursor:pointer"><i class="fas fa-upload"></i> Upload<input type="file" accept="image/*,.pdf" style="display:none" onchange="uploadNote(this)"></label>
  </div>
  <div class="scroll" id="notes-list"><div class="loading"><i class="fas fa-spinner fa-spin"></i></div></div>
</section>

<!-- Timetable -->
<section class="section">
  <div class="section-title"><span><i class="fas fa-calendar-alt"></i> Timetable</span><a href="#" onclick="downloadPDF()">PDF</a></div>
  <div class="table-wrap">
    <table id="timetable">
      <thead><tr><th>Time</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- Attendance -->
<section class="section">
  <div class="section-title"><span><i class="fas fa-calendar-check"></i> Attendance</span></div>
  <div class="scroll" id="attendance-log"><div class="loading"><i class="fas fa-spinner fa-spin"></i></div></div>
</section>

<!-- Events -->
<section class="section">
  <div class="section-title"><span><i class="fas fa-calendar-day"></i> Upcoming Events</span></div>
  <div class="scroll" id="events-list"><div class="loading"><i class="fas fa-spinner fa-spin"></i></div></div>
</section>

<!-- Achievements -->
<section class="section">
  <div class="section-title"><span><i class="fas fa-trophy"></i> Achievements</span></div>
  <div class="scroll" id="achievements-list"><div class="loading"><i class="fas fa-spinner fa-spin"></i></div></div>
</section>

<!-- Library Books -->
<section class="section">
  <div class="section-title"><span><i class="fas fa-book-open"></i> Library Books</span></div>
  <div class="scroll" id="library-list"><div class="loading"><i class="fas fa-spinner fa-spin"></i></div></div>
</section>

<!-- Sports Schedule -->
<section class="section">
  <div class="section-title"><span><i class="fas fa-running"></i> Sports Schedule</span></div>
  <div class="scroll" id="sports-list"><div class="loading"><i class="fas fa-spinner fa-spin"></i></div></div>
</section>

<!-- Exam Timetable -->
<section class="section">
  <div class="section-title"><span><i class="fas fa-clipboard-list"></i> Exam Timetable</span></div>
  <div class="table-wrap">
    <table id="exam-table">
      <thead><tr><th>Date</th><th>Subject</th><th>Time</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- Holidays -->
<section class="section">
  <div class="section-title"><span><i class="fas fa-sun"></i> Holidays</span></div>
  <div class="scroll" id="holidays-list"><div class="loading"><i class="fas fa-spinner fa-spin"></i></div></div>
</section>

<!-- Birthdays -->
<section class="section">
  <div class="section-title"><span><i class="fas fa-birthday-cake"></i> Birthdays</span></div>
  <div class="scroll" id="birthday-list"><div class="loading"><i class="fas fa-spinner fa-spin"></i></div></div>
</section>

<!-- Compliments -->
<section class="section">
  <div class="section-title"><span><i class="fas fa-heart"></i> Compliments</span></div>
  <div class="scroll" id="compliments-list"><div class="loading"><i class="fas fa-spinner fa-spin"></i></div></div>
</section>

<!-- AI FAB -->
<button class="fab" onclick="openAI()" title="AI Assistant"><i class="fas fa-magic"></i></button>

<script>
  /* ===== Firebase ===== */
  firebase.initializeApp({
    apiKey:"AIzaSyB0fHtqeoerlckQ2RXx_VC86cZz_BJaIIU",
    authDomain:"mkps-balrampur.firebaseapp.com",
    projectId:"mkps-balrampur",
    storageBucket:"mkps-balrampur.firebasestorage.app"
  });
  const db=firebase.firestore(),storage=firebase.storage();

  /* ===== Auth & Profile ===== -->
  const sid=localStorage.getItem('studentId');
  const sname=localStorage.getItem('studentName');
  const sclass=localStorage.getItem('studentClass');
  const roll=localStorage.getItem('studentClassRoll');
  if(!sid)location.href='index.html';
  document.getElementById('stuName').textContent=sname;
  document.getElementById('stuFull').textContent=sname;
  document.getElementById('stuClass').textContent=sclass;
  document.getElementById('stuRoll').textContent=roll;

  /* ===== Teacher-Manageable Data ===== -->
  const staticData={
    Nursery:{
      homework:[{subject:'Art',desc:'Draw 3 fruits',date:new Date(),status:'pending'}],
      notes:[{title:'Alphabet A',content:'Write A 5 times'}],
      timetable:[{time:'09-09:30',Mon:'Rhymes',Tue:'Art',Wed:'Story',Thu:'Play',Fri:'Music'}],
      attendance:[{date:new Date(),present:true}],
      events:[{title:'Colouring Competition',date:'2025-09-01'}],
      achievements:[{title:'Best Handwriting',date:'2025-08-20'}],
      library:[{title:'My First Book',author:'ABC',due:'2025-09-01'}],
      sports:[{sport:'Yoga',day:'Mon',time:'09:45-10:15'}],
      exams:[{date:'2025-09-05',subject:'Rhymes',time:'10:00-10:30'}],
      holidays:[{date:'2025-08-26',name:'Raksha Bandhan'}],
      birthdays:[{name:'Aarav',date:'2025-08-26'}],
      compliments:[{text:'Great participation!',teacher:'Ms. Rita'}]
    },
    LKG:{
      homework:[{subject:'English',desc:'A-C 5 times',status:'pending'}],
      timetable:[{time:'08:30-09:15',Mon:'English',Tue:'Math',Wed:'Art',Thu:'Music',Fri:'Play'}],
      events:[{title:'Tell-a-Tale',date:'2025-09-02'}],
      library:[{title:'ABC Book',author:'XYZ',due:'2025-09-10'}],
      sports:[{sport:'Dance',day:'Wed',time:'09:45-10:15'}],
      exams:[{date:'2025-09-10',subject:'English',time:'09:00-09:45'}],
      holidays:[{date:'2025-09-02',name:'Teacher‚Äôs Day'}],
      birthdays:[{name:'Anaya',date:'2025-09-05'}],
      compliments:[{text:'Very polite!',teacher:'Ms. Neha'}]
    },
    '1':{
      homework:[{subject:'Hindi',desc:'‡§µ‡§∞‡•ç‡§£‡§Æ‡§æ‡§≤‡§æ',status:'pending'}],
      timetable:[{time:'08:30-09:15',Mon:'Hindi',Tue:'Math',Wed:'English',Thu:'Art',Fri:'EVS'}],
      events:[{title:'Story Day',date:'2025-09-01'}],
      library:[{title:'Primer Hindi',author:'NCERT',due:'2025-09-15'}],
      sports:[{sport:'Karate',day:'Fri',time:'08:00-08:30'}],
      exams:[{date:'2025-09-15',subject:'Math',time:'09:00-09:45'}],
      holidays:[{date:'2025-09-12',name:'Gandhi Jayanti'}],
      birthdays:[{name:'Rohan',date:'2025-09-18'}],
      compliments:[{text:'Quick learner!',teacher:'Mr. Ajay'}]
    },
    '2':{homework:[{subject:'English',desc:'My School 5 lines',status:'pending'}],timetable:[{time:'08:30-09:15',Mon:'English',Tue:'Math',Wed:'Hindi',Thu:'EVS',Fri:'Art'}]},
    '3':{homework:[{subject:'English',desc:'Paragraph 8 lines',status:'pending'}],timetable:[{time:'08:30-09:15',Mon:'English',Tue:'Math',Wed:'EVS',Thu:'Hindi',Fri:'Science'}]},
    '4':{homework:[{subject:'Science',desc:'Plant diagram',status:'pending'}],timetable:[{time:'08:30-09:15',Mon:'Science',Tue:'Math',Wed:'English',Thu:'Hindi',Fri:'SST'}]},
    '5':{homework:[{subject:'SST',desc:'India map',status:'pending'}],timetable:[{time:'08:30-09:15',Mon:'SST',Tue:'Math',Wed:'Science',Thu:'English',Fri:'Hindi'}]},
    '6':{homework:[{subject:'Hindi',desc:'‡§∏‡§Ç‡§ú‡•ç‡§û‡§æ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏',status:'pending'}],timetable:[{time:'08:30-09:15',Mon:'Hindi',Tue:'Math',Wed:'Science',Thu:'SST',Fri:'English'}]},
    '7':{homework:[{subject:'Science',desc:'Digestive system',status:'pending'}],timetable:[{time:'08:30-09:15',Mon:'Science',Tue:'Math',Wed:'English',Thu:'Hindi',Fri:'SST'}]},
    '8':{homework:[{subject:'SST',desc:'Constitution essay',status:'pending'}],timetable:[{time:'08:30-09:15',Mon:'SST',Tue:'Math',Wed:'Science',Thu:'English',Fri:'Hindi'}]}
  };

  /* ===== Push Static Data (Teacher-manageable) ===== -->
  async function pushStaticData(){
    const cols=['homework','notes','timetable','attendance','events','achievements','library','sports','exams','holidays','birthdays','compliments'];
    for (const col of cols){
      const snap=await db.collection(col).where('class','==',sclass).get();
      if(snap.empty){
        const batch=db.batch();
        staticData[sclass][col].forEach(item=>batch.set(db.collection(col).doc(),{...item,class:sclass}));
        await batch.commit();
      }
    }
  }

  /* ===== Load All Data ===== -->
  async function loadAll(){
    await pushStaticData();
    // homework
    const hwSnap=await db.collection('homework').where('class','==',sclass).orderBy('date','desc').limit(6).get();
    const hwDiv=document.getElementById('homework-list');
    hwDiv.innerHTML='';
    hwSnap.forEach(d=>{
      const h=d.data();
      hwDiv.innerHTML+=`<div class="card">
        <h4>${h.subject}</h4><p>${h.desc}</p><small>${h.date.toDate().toLocaleDateString('en-IN')}</small>
        <span class="pill ${h.status}">${h.status}</span>
      </div>`;
    });
    // notes
    const noteSnap=await db.collection('notes').where('class','==',sclass).orderBy('createdAt','desc').limit(6).get();
    const noteDiv=document.getElementById('notes-list');
    noteDiv.innerHTML='';
    noteSnap.forEach(d=>{
      const n=d.data();
      noteDiv.innerHTML+=`<div class="card"><h4>${n.title}</h4><p>${n.content}</p>${n.imageUrl?'<img src="'+n.imageUrl+'" style="width:100%;border-radius:8px;margin-top:6px">':''}</div>`;
    });
    // timetable
    const ttSnap=await db.collection('timetable').where('class','==',sclass).get();
    const tbody=document.querySelector('#timetable tbody');
    tbody.innerHTML='';
    ttSnap.forEach(d=>{
      const t=d.data();
      tbody.innerHTML+=`<tr><td>${t.time}</td><td>${t.Mon||'-'}</td><td>${t.Tue||'-'}</td><td>${t.Wed||'-'}</td><td>${t.Thu||'-'}</td><td>${t.Fri||'-'}</td></tr>`;
    });
    // attendance
    const attSnap=await db.collection('attendance').where('class','==',sclass).orderBy('date','desc').limit(5).get();
    const attDiv=document.getElementById('attendance-log');
    attDiv.innerHTML='';
    attSnap.forEach(d=>{
      const a=d.data();
      attDiv.innerHTML+=`<div class="card"><p>${a.date.toDate().toLocaleDateString()}: <b>${a.present?'Present':'Absent'}</b></p></div>`;
    });
    // events
    const evSnap=await db.collection('events').where('class','==',sclass).orderBy('date','asc').limit(5).get();
    const evDiv=document.getElementById('events-list');
    evDiv.innerHTML='';
    evSnap.forEach(d=>{
      const e=d.data();
      evDiv.innerHTML+=`<div class="card"><h4>${e.title}</h4><small>${e.date}</small></div>`;
    });
    // achievements
    const achSnap=await db.collection('achievements').where('class','==',sclass).orderBy('date','desc').limit(5).get();
    const achDiv=document.getElementById('achievements-list');
    achDiv.innerHTML='';
    achSnap.forEach(d=>{
      const a=d.data();
      achDiv.innerHTML+=`<div class="card"><h4>${a.title}</h4><small>${a.date}</small></div>`;
    });
    // library
    const libSnap=await db.collection('library').where('class','==',sclass).limit(5).get();
    const libDiv=document.getElementById('library-list');
    libDiv.innerHTML='';
    libSnap.forEach(d=>{
      const l=d.data();
      libDiv.innerHTML+=`<div class="card"><h4>${l.title}</h4><small>Due: ${l.due}</small></div>`;
    });
    // sports
    const sprSnap=await db.collection('sports').where('class','==',sclass).limit(5).get();
    const sprDiv=document.getElementById('sports-list');
    sprDiv.innerHTML='';
    sprSnap.forEach(d=>{
      const s=d.data();
      sprDiv.innerHTML+=`<div class="card"><h4>${s.sport}</h4><small>${s.day} ${s.time}</small></div>`;
    });
    // exams
    const exSnap=await db.collection('exams').where('class','==',sclass).limit(5).get();
    const exDiv=document.querySelector('#exam-table tbody');
    exDiv.innerHTML='';
    exSnap.forEach(d=>{
      const e=d.data();
      exDiv.innerHTML+=`<tr><td>${e.date}</td><td>${e.subject}</td><td>${e.time}</td></tr>`;
    });
    // holidays
    const holSnap=await db.collection('holidays').limit(5).get();
    const holDiv=document.getElementById('holidays-list');
    holDiv.innerHTML='';
    holSnap.forEach(d=>{
      const h=d.data();
      holDiv.innerHTML+=`<div class="card"><h4>${h.name}</h4><small>${h.date}</small></div>`;
    });
    // birthdays
    const bdaySnap=await db.collection('birthdays').where('class','==',sclass).limit(5).get();
    const bdayDiv=document.getElementById('birthday-list');
    bdayDiv.innerHTML='';
    bdaySnap.forEach(d=>{
      const b=d.data();
      bdayDiv.innerHTML+=`<div class="card"><h4>${b.name}</h4><small>${b.date}</small></div>`;
    });
    // compliments
    const compSnap=await db.collection('compliments').where('class','==',sclass).limit(5).get();
    const compDiv=document.getElementById('compliments-list');
    compDiv.innerHTML='';
    compSnap.forEach(d=>{
      const c=d.data();
      compDiv.innerHTML+=`<div class="card"><p><b>‚Äú${c.text}‚Äù</b><br><small>- ${c.teacher}</small></p></div>`;
    });

    // counters
    const hwPenCnt=await db.collection('homework').where('class','==',sclass).where('status','==','pending').count().get();
    document.getElementById('hwPen').textContent=hwPenCnt.data().count||0;
    document.getElementById('notesCnt').textContent=noteSnap.size;
    document.getElementById('events').textContent=evSnap.size;
  }

  /* ===== Upload Note ===== -->
  async function uploadNote(input){
    const file=input.files[0];if(!file)return;
    const path=`notes/${sid}/${Date.now()}_${file.name}`;
    const snap=await storage.ref(path).put(file);
    const url=await snap.ref.getDownloadURL();
    await db.collection('notes').add({class:sclass,title:'My Upload',content:'Student uploaded',imageUrl:url,createdAt:new Date()});
    loadAll();
  }

  /* ===== Utilities ===== -->
  function openModal(type){document.getElementById('modal').classList.add('show');document.getElementById('modalBody').innerHTML=`Full ${type} list coming soon...`;}
  function closeModal(){document.getElementById('modal').classList.remove('show');}
  function downloadPDF(){alert('PDF generator coming soon!');}
  function openAI(){location.href='ai.html';}
  function logout(){localStorage.clear();location.href='index.html';}

  /* ===== On Load ===== -->
  loadAll();
</script>
</body>
</html>
