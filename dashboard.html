<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MKPS ‚Äî Dashboard | Milli Karwaan Public School Balrampur</title>
  <link rel="icon" href="https://i.postimg.cc/ryGx49TB/erasebg-transformed.png">
  <meta name="description" content="Dashboard for Milli Karwaan Public School ‚Äî class-specific homework, teachers, events, notices, timetable, gallery and AI study assistant.">
  <style>
    /* ========================
       MKPS Dashboard - Styles
       Modern, responsive, glassmorphic UI with animations
       ======================== */
    :root{
      --bg-1: #071129;
      --bg-2: #10233a;
      --card: rgba(255,255,255,0.06);
      --glass: rgba(255,255,255,0.06);
      --accent: #dc3545; /* red-ish */
      --accent-2: #ff6f61;
      --muted: #a8b3c4;
      --success: #28a745;
      --danger: #e55353;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(2,6,23,0.6);
      --glass-border: rgba(255,255,255,0.06);
      --max-width: 1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;min-height:100vh;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color: #eef2f6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;flex-direction:column;align-items:center;
    }

    .wrap{width:100%;max-width:var(--max-width);padding:20px;}

/* Header */
    header.appbar{
      width:100%;display:flex;align-items:center;justify-content:space-between;
      gap:12px;padding:18px 20px;border-radius:12px;
      background:linear-gradient(90deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));
      box-shadow: var(--shadow);backdrop-filter: blur(6px);
      margin:12px 0;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:62px;height:62px;border-radius:10px;object-fit:cover;box-shadow:0 6px 18px rgba(0,0,0,0.5)}
    .brand h1{font-size:1.15rem;margin:0;line-height:1;color:#fff}
    .brand p{margin:0;font-size:0.83rem;color:var(--muted)}
    .contact{display:flex;gap:12px;align-items:center}
    .callbtn{background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:10px 14px;border-radius:10px;color:#fff;text-decoration:none;font-weight:600;box-shadow:0 6px 18px rgba(220,53,69,0.2)}
    .contact a{color:#fff;text-decoration:none;font-size:0.9rem}
    .top-actions{display:flex;gap:8px;align-items:center}
    .icon-btn{background:rgba(255,255,255,0.03);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:#fff}
    .small{font-size:0.85rem;color:var(--muted)}

/* Layout */
    main{width:100%;display:grid;grid-template-columns: 1fr 360px;gap:20px;align-items:start}
    @media (max-width:980px){main{grid-template-columns:1fr;}}
    .panel{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:0 8px 30px rgba(0,0,0,0.45);border:1px solid var(--glass-border)}

/* Left column */
    .hero{display:flex;gap:18px;align-items:center}
    .welcome{flex:1}
    .welcome h2{margin:0;font-size:1.3rem}
    .welcome p{margin:6px 0;color:var(--muted)}
    .stats{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap}
    .stat{padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));min-width:120px}
    .stat h3{margin:0;font-size:1rem}
    .stat p{margin:4px 0 0 0;color:var(--muted);font-size:0.82rem}

/* Homework area */
    .homework-area{margin-top:18px;display:flex;flex-direction:column;gap:12px}
    .hw-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .search{flex:1;display:flex;gap:8px}
    .search input{flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff}
    .filter, .btn{padding:10px;border-radius:10px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:600}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff}
    .hw-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:10px}
    .hw-card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);transition:transform .18s ease,box-shadow .18s ease}
    .hw-card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.6)}
    .hw-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .hw-title{font-weight:700;margin:0}
    .hw-sub{font-size:0.85rem;color:var(--muted);margin:6px 0}
    .hw-body{color:#e6eef7;font-size:0.92rem}

/* Teachers / Events / Notices */
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .teacher-card{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02)}
    .teacher-avatar{width:62px;height:62px;border-radius:10px;overflow:hidden;flex-shrink:0;background:linear-gradient(90deg,#fff,rgba(255,255,255,0.1))}
    .teacher-avatar img{width:100%;height:100%;object-fit:cover}
    .teacher-info h4{margin:0;font-size:0.98rem}
    .teacher-info p{margin:6px 0 0 0;color:var(--muted);font-size:0.85rem}

/* Right column (sidebar) */
    aside{display:flex;flex-direction:column;gap:12px}
    .sidebar .panel{padding:12px}
    .quick-search input{width:100%;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:#fff}
    .counts{display:flex;gap:8px;flex-wrap:wrap}
    .count{flex:1;padding:10px;border-radius:10px;text-align:center;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01))}
    .count h4{margin:0}
    .small-muted{font-size:0.82rem;color:var(--muted)}

/* Gallery / Lightbox */
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px}
    .gallery-grid img{width:100%;height:80px;object-fit:cover;border-radius:8px;cursor:pointer;transition:transform .15s}
    .gallery-grid img:hover{transform:scale(1.04)}

/* Footer */
    footer{width:100%;text-align:center;padding:18px;color:var(--muted);margin-top:18px;font-size:0.9rem}

/* Responsive */
    @media (max-width:980px){
      .stats{justify-content:space-between}
      .hero{flex-direction:column;align-items:flex-start}
      .top-actions{position:static;margin-top:12px}
    }

    /* small utilities */
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:0.82rem}
    .hidden{display:none}
    .light-mode body{background:linear-gradient(180deg,#f7f9fb,#e9eef6);color:#111}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header class="appbar panel" role="banner">
      <div class="brand">
        <img src="https://i.postimg.cc/ryGx49TB/erasebg-transformed.png" alt="MKPS logo">
        <div>
          <h1>Milli Karwaan Public School Balrampur</h1>
          <p class="small">Boluha Police Chowki, Balrampur ¬∑ <span class="small-muted">‡§ú‡•ç‡§û‡§æ‡§®, ‡§Ö‡§®‡•Å‡§∂‡§æ‡§∏‡§® ‡§î‡§∞ ‡§∏‡§Æ‡§∞‡•ç‡§™‡§£ ‚Äî ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§ï‡•Ä ‡§∞‡§æ‡§π</span></p>
        </div>
      </div>

      <div class="contact">
        <div class="small muted">Email: <a href="mailto:madamsir066@gmail.com">madamsir066@gmail.com</a></div>
        <a class="callbtn" href="tel:9758919151">Call School ¬∑ 9758919151</a>
        <div class="top-actions">
          <button class="icon-btn" id="exportBtn" title="Export data (JSON)">‚§ì Export</button>
          <button class="icon-btn" id="importBtn" title="Import data (JSON)">‚§í Import</button>
          <button class="icon-btn" id="snapshotBtn" title="Download snapshot (print)">üñ®Ô∏è Snapshot</button>
          <button class="icon-btn" id="themeToggle" title="Toggle theme">üåì</button>
        </div>
      </div>
    </header>

    <!-- Main layout -->
    <main>
      <!-- Left column -->
      <section>
        <div class="panel hero">
          <div class="welcome">
            <h2 id="welcomeTitle">Welcome ‚Äî Student</h2>
            <p id="welcomeSub" class="muted">Your personalized school dashboard. Homework, teachers, notices and study help ‚Äî all in one place.</p>
            <div class="stats" id="topStats" aria-hidden="false">
              <div class="stat"><h3 id="cntStudents">‚Äî</h3><p>Students</p></div>
              <div class="stat"><h3 id="cntTeachers">‚Äî</h3><p>Teachers</p></div>
              <div class="stat"><h3 id="cntNotices">‚Äî</h3><p>Notices</p></div>
              <div class="stat"><h3 id="cntPhotos">‚Äî</h3><p>Gallery</p></div>
            </div>
          </div>
        </div>

        <!-- Homework -->
        <div class="panel homework-area" aria-live="polite">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <h3>Class Homework</h3>
            <div class="small-muted">Showing only homework for your selected class</div>
          </div>

          <div class="hw-controls">
            <div class="search">
              <input id="hwSearch" placeholder="Search homework by keyword..." aria-label="Search homework">
            </div>
            <select id="classFilter" class="filter" aria-label="Filter class">
              <option value="">All classes</option>
            </select>
            <button class="btn btn-ghost" id="refreshBtn">Refresh</button>
            <button class="btn btn-primary" id="printHw">Print</button>
          </div>

          <div class="hw-list" id="hwList" aria-live="polite" aria-atomic="true"></div>
        </div>

        <!-- Teachers & Events -->
        <div class="panel grid-2" style="margin-top:12px;">
          <div>
            <h4>Teachers</h4>
            <div id="teachersList"></div>
          </div>
          <div>
            <h4>Upcoming Events</h4>
            <div id="eventsList"></div>
          </div>
        </div>

        <!-- Notices -->
        <div class="panel" style="margin-top:12px">
          <h4>Notice Board</h4>
          <div id="noticesList"></div>
        </div>

      </section>

      <!-- Right sidebar -->
      <aside>
        <div class="panel sidebar">
          <h4>Quick Tools</h4>
          <div class="quick-search">
            <input id="quickSearch" placeholder="Quick search homework / teachers / notices">
          </div>
          <div style="margin-top:10px" class="counts">
            <div class="count"><h4 id="c1">0</h4><p class="small-muted">Homework</p></div>
            <div class="count"><h4 id="c2">0</h4><p class="small-muted">Teachers</p></div>
            <div class="count"><h4 id="c3">0</h4><p class="small-muted">Events</p></div>
          </div>

          <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:10px 0">

          <h5>Gallery</h5>
          <div class="gallery-grid" id="galleryGrid"></div>

          <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:10px 0">

          <button class="btn btn-ghost" id="viewMessages">View Messages</button>
          <button class="btn btn-ghost" id="contactSchool">Contact School</button>
        </div>

        <div class="panel">
          <h4>Timetable (Sample)</h4>
          <div id="timetable"></div>
        </div>
      </aside>
    </main>

    <footer>
      ¬© <span id="year"></span> Milli Karwaan Public School, Balrampur ¬∑ Address: Boluha Police Chowki ¬∑ Phone: 9758919151
    </footer>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999">
    <div style="max-width:90%;max-height:90%;position:relative">
      <img id="lbImg" src="" alt="gallery image" style="max-width:100%;max-height:100%;border-radius:12px;display:block">
      <button id="lbClose" style="position:absolute;top:-12px;right:-12px;background:#fff;border-radius:999px;padding:10px;border:none;cursor:pointer">‚úï</button>
    </div>
  </div>

  <!-- Modals (hidden) -->
  <div id="modalArea" class="hidden" aria-hidden="true"></div>

  <script>
  /************************************************************************
   MKPS Dashboard - Functionality (heavy inline JS)
   - localStorage keys (shared with admin.html in future):
       mkps_student, mkps_homework, mkps_teachers, mkps_events, mkps_notices,
       mkps_timetable, mkps_gallery, mkps_messages, mkps_update
   - Expose helper functions for admin.html
   ************************************************************************/

  // -----------------------
  // Configuration / API keys
  // -----------------------
  const GEMINI_KEYS = [
    "AIzaSyCdzFBQ1KVgBfmmjSgHJJwcuLbqne9VjUs", // primary
    "AIzaSyCqGS8gb5kh7Jr0pv8d84LxCLhgHU-O_VU"  // fallback
  ];
  // Which generative endpoint (Google Generative Language)
  const GEN_API_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

  // -----------------------
  // Utility helpers
  // -----------------------
  function nowIso(){ return new Date().toISOString(); }
  function uid(len=8){ return Math.random().toString(36).slice(2,2+len) }
  function safeParse(s, fallback){ try{return JSON.parse(s);}catch(e){return fallback} }

  // LocalStorage wrappers
  const storage = {
    get(k){ return safeParse(localStorage.getItem(k), null) },
    set(k,v){ localStorage.setItem(k, JSON.stringify(v)); window.localStorage.setItem('mkps_update', nowIso()) },
    raw(k){ return localStorage.getItem(k) },
    remove(k){ localStorage.removeItem(k); window.localStorage.setItem('mkps_update', nowIso()) }
  };

  // -----------------------
  // Seed demo data (only if missing)
  // -----------------------
  function seedDemoData(){
    if(!storage.get('mkps_homework')){
      const homework = {
        "1":[
          {id:uid(),date:"2025-08-01",subject:"Mathematics",teacher:"Arif Khan",body:"Practice numbers 1‚Äì50. Draw shapes worksheet."},
          {id:uid(),date:"2025-08-02",subject:"English",teacher:"Alka Sharma",body:"Learn A-F letters and practice writing."}
        ],
        "2":[
          {id:uid(),date:"2025-08-01",subject:"Mathematics",teacher:"Arif Khan",body:"Tables 2 and 3. Worksheet pages 3-4."},
          {id:uid(),date:"2025-08-02",subject:"Science",teacher:"Shruti Verma",body:"Collect leaves from 3 plants and paste them."}
        ],
        "3":[
          {id:uid(),date:"2025-08-03",subject:"Mathematics",teacher:"Arif Khan",body:"Simple fractions, worksheets."}
        ],
        "4":[
          {id:uid(),date:"2025-08-03",subject:"Science",teacher:"Shruti Verma",body:"Solar system reading: pages 12-15."}
        ],
        "5":[
          {id:uid(),date:"2025-08-04",subject:"English",teacher:"Prakash Singh",body:"Write an essay on school safety."}
        ],
        "6":[
          {id:uid(),date:"2025-08-05",subject:"Computer Science",teacher:"Riya Thomas",body:"Intro to algorithms: write a recipe as steps."}
        ],
        "7":[
          {id:uid(),date:"2025-08-05",subject:"Social Studies",teacher:"Neeraj Gupta",body:"Map work: mark important rivers."}
        ],
        "8":[
          {id:uid(),date:"2025-08-06",subject:"Science",teacher:"Shruti Verma",body:"Periodic table assignment: learn first 10 elements."}
        ]
      };
      localStorage.setItem('mkps_homework', JSON.stringify(homework));
    }

    if(!storage.get('mkps_teachers')){
      const teachers = [
        {id:uid(),name:"Arif Khan",subject:"Mathematics",phone:"",email:"",photo:"https://placehold.co/200x200?text=Arif"},
        {id:uid(),name:"Shruti Verma",subject:"Science",phone:"",email:"",photo:"https://placehold.co/200x200?text=Shruti"},
        {id:uid(),name:"Prakash Singh",subject:"English",phone:"",email:"",photo:"https://placehold.co/200x200?text=Prakash"},
        {id:uid(),name:"Riya Thomas",subject:"Computer Science",phone:"",email:"",photo:"https://placehold.co/200x200?text=Riya"},
        {id:uid(),name:"Neeraj Gupta",subject:"Social Studies",phone:"",email:"",photo:"https://placehold.co/200x200?text=Neeraj"},
        {id:uid(),name:"Alka Sharma",subject:"Hindi",phone:"",email:"",photo:"https://placehold.co/200x200?text=Alka"}
      ];
      localStorage.setItem('mkps_teachers', JSON.stringify(teachers));
    }

    if(!storage.get('mkps_events')){
      const events = [
        {id:uid(),title:"Independence Day Program",date:"2025-08-15",time:"09:00",location:"School Ground",desc:"Flag hoisting and cultural program."},
        {id:uid(),title:"Annual Sports Meet",date:"2025-09-10",time:"07:30",location:"Sports Field",desc:"Athletics and group games."}
      ];
      localStorage.setItem('mkps_events', JSON.stringify(events));
    }

    if(!storage.get('mkps_notices')){
      const notices = [
        {id:uid(),title:"Covid Guidelines Update",date:"2025-07-10",priority:"high",body:"Mask recommended for all visitors."},
        {id:uid(),title:"Library Timing",date:"2025-07-20",priority:"low",body:"Library open 8:00 AM - 2:00 PM."}
      ];
      localStorage.setItem('mkps_notices', JSON.stringify(notices));
    }

    if(!storage.get('mkps_timetable')){
      const tt = {
        "1":[["Math","English","Play"],["Hindi","Arts","Math"]],
        "2":[["Math","Science","English"],["Sports","Hindi","Math"]],
        "3":[["Math","Science","English"],["Computer","Hindi","Arts"]],
        "4":[["Math","Science","English"],["Computer","Hindi","Arts"]],
        "5":[["Math","Science","English"],["Computer","Hindi","Arts"]],
        "6":[["Math","Science","English"],["Computer","Hindi","Social"]],
        "7":[["Math","Science","English"],["Computer","Hindi","Social"]],
        "8":[["Math","Science","English"],["Computer","Hindi","Social"]]
      };
      localStorage.setItem('mkps_timetable', JSON.stringify(tt));
    }

    if(!storage.get('mkps_gallery')){
      const gallery = [
        {id:uid(),src:"https://placehold.co/600x400?text=School+1",caption:"Campus view"},
        {id:uid(),src:"https://placehold.co/600x400?text=School+2",caption:"Assembly"},
        {id:uid(),src:"https://placehold.co/600x400?text=School+3",caption:"Sports Day"}
      ];
      localStorage.setItem('mkps_gallery', JSON.stringify(gallery));
    }

    if(!storage.get('mkps_messages')){
      localStorage.setItem('mkps_messages', JSON.stringify([]));
    }

    // set some analytics counters (seed)
    if(!localStorage.getItem('mkps_meta')){
      localStorage.setItem('mkps_meta', JSON.stringify({
        students:1245, teachers:12, notices:2, photos:3
      }));
    }
  }

  // Run seeding at load
  seedDemoData();

  // -----------------------
  // Read current logged-in student (from index.html)
  // -----------------------
  const currentStudent = storage.get('mkps_student');
  if(!currentStudent){
    // No student ‚Äî redirect back to index
    console.warn('No mkps_student found ‚Äî redirecting to index.');
    setTimeout(()=>{ location.href = 'index.html' }, 600);
  }

  // -----------------------
  // Render functions
  // -----------------------
  function renderHeaderInfo(){
    const name = currentStudent?.name || 'Student';
    const cls = currentStudent?.class || '‚Äî';
    const parent = currentStudent?.parent || currentStudent?.email || '‚Äî';
    document.getElementById('welcomeTitle').textContent = `Welcome, ${name}`;
    document.getElementById('welcomeSub').textContent = `Class: ${cls} ¬∑ Parent: ${parent}`;
    document.getElementById('year').textContent = new Date().getFullYear();
  }

  function renderStats(){
    const meta = safeParse(localStorage.getItem('mkps_meta'), {students:'‚Äî',teachers:'‚Äî',notices:'‚Äî',photos:'‚Äî'});
    document.getElementById('cntStudents').textContent = meta.students ?? '‚Äî';
    document.getElementById('cntTeachers').textContent = meta.teachers ?? '‚Äî';
    document.getElementById('cntNotices').textContent = meta.notices ?? '‚Äî';
    document.getElementById('cntPhotos').textContent = meta.photos ?? '‚Äî';
  }

  // Populate class filter (1-12 but index only 1-8 requested)
  function populateClassFilter(){
    const sel = document.getElementById('classFilter');
    sel.innerHTML = '<option value="">All classes</option>';
    for(let i=1;i<=12;i++){
      const opt = document.createElement('option'); opt.value = String(i); opt.textContent = `Class ${i}`;
      if(i<=8) sel.appendChild(opt); // show 1-8 by default, but value supports up to 12
    }
    if(currentStudent?.class) sel.value = currentStudent.class;
  }

  // Render homework for selected class (or student's class)
  function renderHomework(filterKeyword='', filterClass=''){
    const allHw = safeParse(localStorage.getItem('mkps_homework'), {});
    const hwContainer = document.getElementById('hwList'); hwContainer.innerHTML = '';
    // determine which class to show by default: student's class
    const defaultClass = String(currentStudent?.class || (filterClass || ''));
    const activeClass = filterClass || defaultClass || '';
    // If no activeClass, gather all classes
    const classesToShow = activeClass ? [activeClass] : Object.keys(allHw).sort();
    const results = [];
    classesToShow.forEach(cls => {
      const items = allHw[cls] || [];
      items.forEach(item => {
        // basic keyword filter
        const hay = `${item.subject} ${item.teacher} ${item.body} ${item.date} ${cls}`.toLowerCase();
        if(!filterKeyword || hay.includes(filterKeyword.toLowerCase())){
          results.push(Object.assign({class:cls}, item));
        }
      });
    });

    // sort by date desc
    results.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
    if(results.length===0){
      hwContainer.innerHTML = '<div class="muted">No homework found for the selected class / search.</div>';
      document.getElementById('c1').textContent = 0;
      return;
    }

    document.getElementById('c1').textContent = results.length;

    results.forEach(item=>{
      const card = document.createElement('article'); card.className='hw-card';
      const meta = document.createElement('div'); meta.className='hw-meta';
      const title = document.createElement('div'); title.innerHTML = `<div class="hw-title">${item.subject} <span class="pill">Class ${item.class}</span></div>`;
      const date = document.createElement('div'); date.innerHTML = `<div class="muted">${item.date}</div>`;
      meta.appendChild(title); meta.appendChild(date);

      const sub = document.createElement('div'); sub.className='hw-sub'; sub.textContent = `Teacher: ${item.teacher || '‚Äî'}`;

      const body = document.createElement('div'); body.className='hw-body'; body.textContent = item.body || '';

      card.appendChild(meta); card.appendChild(sub); card.appendChild(body);

      // quick actions
      const actions = document.createElement('div'); actions.style.marginTop='10px'; actions.style.display='flex'; actions.style.gap='8px';
      const saveBtn = document.createElement('button'); saveBtn.className='btn btn-ghost'; saveBtn.textContent='Save PDF';
      saveBtn.onclick = ()=> downloadHomeworkSnapshot([item]);
      const shareBtn = document.createElement('button'); shareBtn.className='btn btn-ghost'; shareBtn.textContent='Share';
      shareBtn.onclick = ()=> { navigator.share ? navigator.share({title:'Homework',text:`${item.subject} ‚Äî ${item.body}`}) : alert('Share not available on this device') }
      actions.appendChild(saveBtn); actions.appendChild(shareBtn);
      card.appendChild(actions);

      hwContainer.appendChild(card);
    });
  }

  // Render teachers
  function renderTeachers(){
    const teachers = safeParse(localStorage.getItem('mkps_teachers'), []);
    const container = document.getElementById('teachersList'); container.innerHTML='';
    document.getElementById('c2').textContent = teachers.length || 0;
    teachers.forEach(t=>{
      const el = document.createElement('div'); el.className='teacher-card';
      el.innerHTML = `<div class="teacher-avatar"><img alt="${t.name}" src="${t.photo || 'https://placehold.co/200x200?text=Teacher'}"></div>
                      <div class="teacher-info"><h4>${t.name}</h4><p class="muted">${t.subject}</p></div>`;
      container.appendChild(el);
    });
  }

  // Render events
  function renderEvents(){
    const events = safeParse(localStorage.getItem('mkps_events'), []);
    const container = document.getElementById('eventsList'); container.innerHTML='';
    document.getElementById('c3').textContent = events.length || 0;
    events.forEach(ev=>{
      const el = document.createElement('div'); el.style.marginBottom='8px';
      el.innerHTML = `<strong>${ev.title}</strong><div class="muted">${ev.date} ‚Ä¢ ${ev.time} ‚Ä¢ ${ev.location}</div><div style="margin-top:6px">${ev.desc}</div>`;
      container.appendChild(el);
    });
  }

  // Render notices
  function renderNotices(){
    const notices = safeParse(localStorage.getItem('mkps_notices'), []);
    const container = document.getElementById('noticesList'); container.innerHTML='';
    notices.forEach(n=>{
      const el = document.createElement('div'); el.style.padding='10px'; el.style.marginBottom='8px'; el.style.borderRadius='10px';
      el.style.background = n.priority==='high' ? 'linear-gradient(90deg,rgba(255,80,80,0.06),rgba(255,80,80,0.02))' : 'rgba(255,255,255,0.02)';
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${n.title}</strong><span class="small-muted">${n.date}</span></div>
                      <div class="muted" style="margin-top:6px">${n.body}</div>`;
      container.appendChild(el);
    });
  }

  // Render gallery
  function renderGallery(){
    const gallery = safeParse(localStorage.getItem('mkps_gallery'), []);
    const grid = document.getElementById('galleryGrid'); grid.innerHTML='';
    gallery.forEach(img=>{
      const el = document.createElement('img'); el.src=img.src; el.alt=img.caption||'Gallery';
      el.addEventListener('click',()=> openLightbox(img.src));
      grid.appendChild(el);
    });
  }

  // Render timetable (simple)
  function renderTimetable(){
    const tt = safeParse(localStorage.getItem('mkps_timetable'), {});
    const cls = String(currentStudent?.class || '');
    const container = document.getElementById('timetable'); container.innerHTML='';
    const days = ['Mon','Tue','Wed','Thu','Fri'];
    const table = document.createElement('div');
    if(tt[cls]){
      const rows = tt[cls];
      rows.forEach((row, idx) => {
        const r = document.createElement('div'); r.style.display='flex'; r.style.gap='8px'; r.style.marginBottom='6px';
        row.forEach(cell=>{
          const c = document.createElement('div'); c.style.flex='1'; c.style.padding='8px'; c.style.borderRadius='8px'; c.style.background='rgba(255,255,255,0.02)';
          c.textContent = cell;
          r.appendChild(c);
        });
        table.appendChild(r);
      });
      container.appendChild(table);
    } else {
      container.innerHTML = '<div class="muted">Timetable not set for this class.</div>';
    }
  }

  // -----------------------
  // Export / Import / Snapshot
  // -----------------------
  function exportAllData(){
    const keys = ['mkps_student','mkps_homework','mkps_teachers','mkps_events','mkps_notices','mkps_timetable','mkps_gallery','mkps_messages','mkps_meta'];
    const out = {};
    keys.forEach(k=> out[k] = safeParse(localStorage.getItem(k), null));
    const blob = new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'mkps_export_'+(new Date()).toISOString().slice(0,10)+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function importAllData(json){
    try{
      const parsed = typeof json === 'string' ? JSON.parse(json) : json;
      const keys = Object.keys(parsed);
      keys.forEach(k=>{
        if(parsed[k] !== null) localStorage.setItem(k, JSON.stringify(parsed[k]));
        else localStorage.removeItem(k);
      });
      window.localStorage.setItem('mkps_update', nowIso());
      alert('Import successful ‚Äî data loaded. Refreshing view.');
      refreshAll();
    }catch(e){
      alert('Import failed: '+e.message);
    }
  }

  function downloadHomeworkSnapshot(items){
    // produce a simple HTML snapshot
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Homework Snapshot</title>
    <style>body{font-family:Arial,sans-serif;padding:20px;color:#111} .card{border:1px solid #ddd;padding:12px;margin-bottom:10px;border-radius:8px}</style>
    </head><body><h1>Homework Snapshot ‚Äî ${new Date().toLocaleDateString()}</h1>${items.map(it=>`<div class="card"><h2>${it.subject} (Class ${it.class})</h2><div><strong>Date:</strong> ${it.date}</div><div><strong>Teacher:</strong>${it.teacher}</div><p>${it.body}</p></div>`).join('')}</body></html>`;
    const blob = new Blob([html], {type:'text/html'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'homework_snapshot.html'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // print current homework view
  function printHomeworkView(){
    const clone = document.getElementById('hwList').cloneNode(true);
    const w = window.open('','_blank','width=900,height=700'); w.document.write('<html><head><title>Print Homework</title></head><body>');
    w.document.write('<h1>Class Homework ‚Äî '+(currentStudent?.class || '')+'</h1>');
    w.document.write(clone.outerHTML);
    w.document.write('</body></html>'); w.document.close(); w.print();
  }

  // -----------------------
  // Lightbox
  // -----------------------
  function openLightbox(src){
    const lb = document.getElementById('lightbox'); const img = document.getElementById('lbImg');
    img.src = src; lb.classList.remove('hidden'); lb.style.display = 'flex';
  }
  document.getElementById('lbClose').addEventListener('click',()=>{ document.getElementById('lightbox').classList.add('hidden'); document.getElementById('lightbox').style.display='none'; });

  // -----------------------
  // Messages modal & contact
  // -----------------------
  function showMessages(){
    const msgs = safeParse(localStorage.getItem('mkps_messages'), []);
    const html = `<div style="max-width:600px;background:#fff;color:#111;padding:16px;border-radius:10px"><h3>Saved Messages</h3>${msgs.length?msgs.map(m=>`<div style="border-bottom:1px solid #eee;padding:8px 0"><strong>${m.name||'Anonymous'}</strong><div style="font-size:0.9rem;color:#444">${m.message}</div><div style="font-size:0.8rem;color:#666">${m.date}</div></div>`).join(''):'<div style="color:#666">No messages yet.</div>'}<div style="margin-top:12px;text-align:right"><button id="closeMsgs">Close</button></div></div>`;
    const win = window.open('','mkps_msgs','width=600,height=600'); win.document.write(html);
    win.document.close();
  }
  function contactSchool(){
    // open mail client
    location.href = 'mailto:madamsir066@gmail.com?subject=Contact%20MKPS%20Portal';
  }

  // -----------------------
  // AI -> Study-only helper
  // -----------------------
  // This function sends study-related queries to Gemini endpoint. It includes a forced instruction to answer for study help only.
  async function askStudyAI(promptText){
    const key = GEMINI_KEYS[0] || '';
    if(!key){ throw new Error('No API key configured'); }
    const systemPrefix = `You are a helpful study assistant for school students of Milli Karwaan Public School. Answer politely and clearly, provide step-by-step explanations, examples, and small practice exercises where appropriate. Do NOT provide anything unsafe or unrelated. Answer for study/help only. Keep language simple and encouraging.`;
    const body = {
      // Using the simple contents structure that the public endpoint expects
      contents: [
        { parts: [{ text: systemPrefix + "\n\nStudent question: " + promptText }] }
      ],
      // optionals can be added; leaving defaults
    };

    // Try primary key; if fails, try fallback
    for(let k of GEMINI_KEYS){
      try{
        const res = await fetch(`${GEN_API_BASE}?key=${k}`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        if(!res.ok){
          const text = await res.text();
          console.warn('AI non-ok', res.status, text);
          throw new Error('AI request failed: '+res.status);
        }
        const data = await res.json();
        // parse candidate text safely
        const out = (data?.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) || (data?.output?.[0]?.content?.[0]?.text) || JSON.stringify(data);
        return String(out);
      }catch(err){
        console.warn('AI call failed with key', k, err);
        // try next key
      }
    }
    throw new Error('All AI keys failed or network error.');
  }

  // Hook AI UI
  (function attachAIHandlers(){
    // we place a listener on the page to handle AI questions via a lightweight prompt button
    // For compactness, we create a floating quick-AI button that opens a small prompt.
    const floatBtn = document.createElement('button'); floatBtn.className='icon-btn'; floatBtn.title='Ask Study AI'; floatBtn.textContent='ü§ñ AI';
    floatBtn.style.position='fixed'; floatBtn.style.right='18px'; floatBtn.style.bottom='18px'; floatBtn.style.zIndex=9999;
    document.body.appendChild(floatBtn);
    floatBtn.addEventListener('click', async ()=>{
      const q = prompt('Ask study-related question (math/science/english/homework):');
      if(!q) return;
      try{
        floatBtn.textContent = '‚è≥';
        const ans = await askStudyAI(q);
        floatBtn.textContent = 'ü§ñ AI';
        alert('AI Answer (copy from dialog):\n\n' + ans);
      }catch(e){
        floatBtn.textContent = 'ü§ñ AI';
        alert('AI error: ' + (e.message || e));
      }
    });
  })();

  // -----------------------
  // Storage event listener to auto-refresh when admin.html updates mkps_update
  // -----------------------
  window.addEventListener('storage', (e)=>{
    if(e.key === 'mkps_update'){
      console.log('mkps_update triggered. Refreshing data...');
      refreshAll();
    }
  });

  // -----------------------
  // Refresh / Initialization
  // -----------------------
  function refreshAll(){
    renderHeaderInfo();
    renderStats();
    populateClassFilter();
    renderTeachers();
    renderEvents();
    renderNotices();
    renderGallery();
    renderTimetable();
    // initial render homework: show student's class only
    const studentClass = String(currentStudent?.class || '');
    renderHomework('', studentClass);
    // update counters
    document.getElementById('hwSearch').value = '';
    document.getElementById('quickSearch').value = '';
  }

  // Bind UI events
  document.getElementById('hwSearch').addEventListener('input', (e)=>{
    renderHomework(e.target.value, document.getElementById('classFilter').value);
  });
  document.getElementById('classFilter').addEventListener('change', (e)=>{
    renderHomework(document.getElementById('hwSearch').value, e.target.value);
  });
  document.getElementById('refreshBtn').addEventListener('click', ()=> refreshAll());
  document.getElementById('printHw').addEventListener('click', ()=> printHomeworkView());
  document.getElementById('exportBtn').addEventListener('click', ()=> exportAllData());
  document.getElementById('importBtn').addEventListener('click', ()=> {
    const f = prompt('Paste JSON export here to import (this will replace data):');
    if(f) importAllData(f);
  });
  document.getElementById('snapshotBtn').addEventListener('click', ()=>{
    // snapshot current homework list (all visible)
    // convert visible hw items to a simple array and download
    const nodes = Array.from(document.querySelectorAll('#hwList .hw-card'));
    const items = nodes.map(n => {
      return {
        title: n.querySelector('.hw-title')?.innerText || '',
        meta: n.querySelector('.hw-sub')?.innerText || '',
        body: n.querySelector('.hw-body')?.innerText || ''
      };
    });
    downloadHomeworkSnapshot(items);
  });
  document.getElementById('themeToggle').addEventListener('click', ()=> {
    document.body.classList.toggle('light'); // simple theme flip
  });
  document.getElementById('viewMessages').addEventListener('click', ()=> showMessages());
  document.getElementById('contactSchool').addEventListener('click', ()=> contactSchool());

  // Quick search to look through homework/teachers/notices
  document.getElementById('quickSearch').addEventListener('input', (e)=>{
    const q = e.target.value.trim().toLowerCase();
    // search homework (display results)
    if(q.length>0){
      renderHomework(q,'');
    }else{
      renderHomework('','');
    }
  });

  // Auto-run refresh
  refreshAll();

  // -----------------------
  // Expose admin hooks (hidden) ‚Äî admin.html will use these functions
  // -----------------------
  window.renderHomeworkFor = function(cls){
    document.getElementById('classFilter').value = String(cls);
    renderHomework('', String(cls));
  };
  window.refreshTeachers = function(){ renderTeachers(); };
  window.refreshEvents = function(){ renderEvents(); };
  window.refreshNotices = function(){ renderNotices(); };
  window.refreshTimetable = function(){ renderTimetable(); };
  window.refreshGallery = function(){ renderGallery(); };
  window.refreshMessages = function(){ /* admin can read mkps_messages directly */ };
  window.exportMkpsData = function(){ exportAllData(); };

  // -----------------------
  // Hidden admin hook example (not shown in UI): call openAdminPrompt() to validate password 'Abutalha'
  // admin.html should not be linked visibly; instead it will use localStorage keys directly.
  // -----------------------
  window.openAdminPrompt = function(){
    const pass = prompt('Enter admin password: (hidden)'); 
    if(pass === 'Abutalha'){
      // open admin.html in new tab (admin.html not provided here until requested)
      window.open('admin.html','_blank');
    } else {
      alert('Incorrect password');
    }
  };

  // -----------------------
  // Small UX: allow pressing Escape to close lightbox (keyboard)
  // -----------------------
  document.addEventListener('keydown', (e)=> {
    if(e.key === 'Escape'){
      const lb = document.getElementById('lightbox');
      if(lb && !lb.classList.contains('hidden')) { lb.classList.add('hidden'); lb.style.display='none'; }
    }
  });

  // -----------------------
  // Accessibility: small focus indicator
  // -----------------------
  document.addEventListener('focusin', (e)=> e.target.style.outline = '2px solid rgba(255,255,255,0.06)');
  document.addEventListener('focusout', (e)=> e.target.style.outline = 'none');

  // -----------------------
  // Final: ensure footer year set already (redundant safe)
  // -----------------------
  document.getElementById('year').textContent = new Date().getFullYear();

  // Informational console help for admin devs
  console.log("MKPS Dashboard loaded. Admin hooks available: window.renderHomeworkFor(), window.refreshTeachers(), window.refreshEvents(), window.openAdminPrompt() (password hidden).");
  </script>
</body>
</html>
